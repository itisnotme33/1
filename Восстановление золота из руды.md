

<h1>Содержание<span class="tocSkip"></span></h1>
<div class="toc"><ul class="toc-item"><li><span><a href="#Подготовка-данных" data-toc-modified-id="Подготовка-данных-1"><span class="toc-item-num">1&nbsp;&nbsp;</span>Подготовка данных</a></span></li><li><span><a href="#Анализ-данных" data-toc-modified-id="Анализ-данных-2"><span class="toc-item-num">2&nbsp;&nbsp;</span>Анализ данных</a></span></li><li><span><a href="#Модель" data-toc-modified-id="Модель-3"><span class="toc-item-num">3&nbsp;&nbsp;</span>Модель</a></span></li><li><span><a href="#Чек-лист-готовности-проекта" data-toc-modified-id="Чек-лист-готовности-проекта-4"><span class="toc-item-num">4&nbsp;&nbsp;</span>Чек-лист готовности проекта</a></span></li></ul></div>

# Восстановление золота из руды

Подготовьте прототип модели машинного обучения для «Цифры». Компания разрабатывает решения для эффективной работы промышленных предприятий.

Модель должна предсказать коэффициент восстановления золота из золотосодержащей руды. Используйте данные с параметрами добычи и очистки. 

Модель поможет оптимизировать производство, чтобы не запускать предприятие с убыточными характеристиками.

Вам нужно:

1. Подготовить данные;
2. Провести исследовательский анализ данных;
3. Построить и обучить модель.

Чтобы выполнить проект, обращайтесь к библиотекам *pandas*, *matplotlib* и *sklearn.* Вам поможет их документация.

## Подготовка данных


```python
import pandas as pd
import numpy as np

from sklearn.preprocessing import StandardScaler
from sklearn.dummy import DummyRegressor
from sklearn.model_selection import cross_val_score
from sklearn.metrics import make_scorer
from sklearn.tree import DecisionTreeRegressor
from sklearn.ensemble import RandomForestRegressor

import matplotlib.pyplot as plt

from sklearn.metrics import mean_absolute_error
from sklearn.pipeline import  make_pipeline
import seaborn as sns
from sklearn.pipeline import Pipeline
from sklearn.dummy import DummyRegressor


from sklearn.model_selection import GridSearchCV
from sklearn.model_selection import RandomizedSearchCV
from sklearn.model_selection import KFold
import warnings
warnings.filterwarnings("ignore")
```



```python
data_train = pd.read_csv('/datasets/gold_recovery_train_new.csv')
data_train.info()
data_train.head()
```

    <class 'pandas.core.frame.DataFrame'>
    RangeIndex: 14149 entries, 0 to 14148
    Data columns (total 87 columns):
     #   Column                                              Non-Null Count  Dtype  
    ---  ------                                              --------------  -----  
     0   date                                                14149 non-null  object 
     1   final.output.concentrate_ag                         14148 non-null  float64
     2   final.output.concentrate_pb                         14148 non-null  float64
     3   final.output.concentrate_sol                        13938 non-null  float64
     4   final.output.concentrate_au                         14149 non-null  float64
     5   final.output.recovery                               14149 non-null  float64
     6   final.output.tail_ag                                14149 non-null  float64
     7   final.output.tail_pb                                14049 non-null  float64
     8   final.output.tail_sol                               14144 non-null  float64
     9   final.output.tail_au                                14149 non-null  float64
     10  primary_cleaner.input.sulfate                       14129 non-null  float64
     11  primary_cleaner.input.depressant                    14117 non-null  float64
     12  primary_cleaner.input.feed_size                     14149 non-null  float64
     13  primary_cleaner.input.xanthate                      14049 non-null  float64
     14  primary_cleaner.output.concentrate_ag               14149 non-null  float64
     15  primary_cleaner.output.concentrate_pb               14063 non-null  float64
     16  primary_cleaner.output.concentrate_sol              13863 non-null  float64
     17  primary_cleaner.output.concentrate_au               14149 non-null  float64
     18  primary_cleaner.output.tail_ag                      14148 non-null  float64
     19  primary_cleaner.output.tail_pb                      14134 non-null  float64
     20  primary_cleaner.output.tail_sol                     14103 non-null  float64
     21  primary_cleaner.output.tail_au                      14149 non-null  float64
     22  primary_cleaner.state.floatbank8_a_air              14145 non-null  float64
     23  primary_cleaner.state.floatbank8_a_level            14148 non-null  float64
     24  primary_cleaner.state.floatbank8_b_air              14145 non-null  float64
     25  primary_cleaner.state.floatbank8_b_level            14148 non-null  float64
     26  primary_cleaner.state.floatbank8_c_air              14147 non-null  float64
     27  primary_cleaner.state.floatbank8_c_level            14148 non-null  float64
     28  primary_cleaner.state.floatbank8_d_air              14146 non-null  float64
     29  primary_cleaner.state.floatbank8_d_level            14148 non-null  float64
     30  rougher.calculation.sulfate_to_au_concentrate       14148 non-null  float64
     31  rougher.calculation.floatbank10_sulfate_to_au_feed  14148 non-null  float64
     32  rougher.calculation.floatbank11_sulfate_to_au_feed  14148 non-null  float64
     33  rougher.calculation.au_pb_ratio                     14149 non-null  float64
     34  rougher.input.feed_ag                               14149 non-null  float64
     35  rougher.input.feed_pb                               14049 non-null  float64
     36  rougher.input.feed_rate                             14141 non-null  float64
     37  rougher.input.feed_size                             14005 non-null  float64
     38  rougher.input.feed_sol                              14071 non-null  float64
     39  rougher.input.feed_au                               14149 non-null  float64
     40  rougher.input.floatbank10_sulfate                   14120 non-null  float64
     41  rougher.input.floatbank10_xanthate                  14141 non-null  float64
     42  rougher.input.floatbank11_sulfate                   14113 non-null  float64
     43  rougher.input.floatbank11_xanthate                  13721 non-null  float64
     44  rougher.output.concentrate_ag                       14149 non-null  float64
     45  rougher.output.concentrate_pb                       14149 non-null  float64
     46  rougher.output.concentrate_sol                      14127 non-null  float64
     47  rougher.output.concentrate_au                       14149 non-null  float64
     48  rougher.output.recovery                             14149 non-null  float64
     49  rougher.output.tail_ag                              14148 non-null  float64
     50  rougher.output.tail_pb                              14149 non-null  float64
     51  rougher.output.tail_sol                             14149 non-null  float64
     52  rougher.output.tail_au                              14149 non-null  float64
     53  rougher.state.floatbank10_a_air                     14148 non-null  float64
     54  rougher.state.floatbank10_a_level                   14148 non-null  float64
     55  rougher.state.floatbank10_b_air                     14148 non-null  float64
     56  rougher.state.floatbank10_b_level                   14148 non-null  float64
     57  rougher.state.floatbank10_c_air                     14148 non-null  float64
     58  rougher.state.floatbank10_c_level                   14148 non-null  float64
     59  rougher.state.floatbank10_d_air                     14149 non-null  float64
     60  rougher.state.floatbank10_d_level                   14149 non-null  float64
     61  rougher.state.floatbank10_e_air                     13713 non-null  float64
     62  rougher.state.floatbank10_e_level                   14149 non-null  float64
     63  rougher.state.floatbank10_f_air                     14149 non-null  float64
     64  rougher.state.floatbank10_f_level                   14149 non-null  float64
     65  secondary_cleaner.output.tail_ag                    14147 non-null  float64
     66  secondary_cleaner.output.tail_pb                    14139 non-null  float64
     67  secondary_cleaner.output.tail_sol                   12544 non-null  float64
     68  secondary_cleaner.output.tail_au                    14149 non-null  float64
     69  secondary_cleaner.state.floatbank2_a_air            13932 non-null  float64
     70  secondary_cleaner.state.floatbank2_a_level          14148 non-null  float64
     71  secondary_cleaner.state.floatbank2_b_air            14128 non-null  float64
     72  secondary_cleaner.state.floatbank2_b_level          14148 non-null  float64
     73  secondary_cleaner.state.floatbank3_a_air            14145 non-null  float64
     74  secondary_cleaner.state.floatbank3_a_level          14148 non-null  float64
     75  secondary_cleaner.state.floatbank3_b_air            14148 non-null  float64
     76  secondary_cleaner.state.floatbank3_b_level          14148 non-null  float64
     77  secondary_cleaner.state.floatbank4_a_air            14143 non-null  float64
     78  secondary_cleaner.state.floatbank4_a_level          14148 non-null  float64
     79  secondary_cleaner.state.floatbank4_b_air            14148 non-null  float64
     80  secondary_cleaner.state.floatbank4_b_level          14148 non-null  float64
     81  secondary_cleaner.state.floatbank5_a_air            14148 non-null  float64
     82  secondary_cleaner.state.floatbank5_a_level          14148 non-null  float64
     83  secondary_cleaner.state.floatbank5_b_air            14148 non-null  float64
     84  secondary_cleaner.state.floatbank5_b_level          14148 non-null  float64
     85  secondary_cleaner.state.floatbank6_a_air            14147 non-null  float64
     86  secondary_cleaner.state.floatbank6_a_level          14148 non-null  float64
    dtypes: float64(86), object(1)
    memory usage: 9.4+ MB






<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>date</th>
      <th>final.output.concentrate_ag</th>
      <th>final.output.concentrate_pb</th>
      <th>final.output.concentrate_sol</th>
      <th>final.output.concentrate_au</th>
      <th>final.output.recovery</th>
      <th>final.output.tail_ag</th>
      <th>final.output.tail_pb</th>
      <th>final.output.tail_sol</th>
      <th>final.output.tail_au</th>
      <th>...</th>
      <th>secondary_cleaner.state.floatbank4_a_air</th>
      <th>secondary_cleaner.state.floatbank4_a_level</th>
      <th>secondary_cleaner.state.floatbank4_b_air</th>
      <th>secondary_cleaner.state.floatbank4_b_level</th>
      <th>secondary_cleaner.state.floatbank5_a_air</th>
      <th>secondary_cleaner.state.floatbank5_a_level</th>
      <th>secondary_cleaner.state.floatbank5_b_air</th>
      <th>secondary_cleaner.state.floatbank5_b_level</th>
      <th>secondary_cleaner.state.floatbank6_a_air</th>
      <th>secondary_cleaner.state.floatbank6_a_level</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2016-01-15 00:00:00</td>
      <td>6.055403</td>
      <td>9.889648</td>
      <td>5.507324</td>
      <td>42.192020</td>
      <td>70.541216</td>
      <td>10.411962</td>
      <td>0.895447</td>
      <td>16.904297</td>
      <td>2.143149</td>
      <td>...</td>
      <td>14.016835</td>
      <td>-502.488007</td>
      <td>12.099931</td>
      <td>-504.715942</td>
      <td>9.925633</td>
      <td>-498.310211</td>
      <td>8.079666</td>
      <td>-500.470978</td>
      <td>14.151341</td>
      <td>-605.841980</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2016-01-15 01:00:00</td>
      <td>6.029369</td>
      <td>9.968944</td>
      <td>5.257781</td>
      <td>42.701629</td>
      <td>69.266198</td>
      <td>10.462676</td>
      <td>0.927452</td>
      <td>16.634514</td>
      <td>2.224930</td>
      <td>...</td>
      <td>13.992281</td>
      <td>-505.503262</td>
      <td>11.950531</td>
      <td>-501.331529</td>
      <td>10.039245</td>
      <td>-500.169983</td>
      <td>7.984757</td>
      <td>-500.582168</td>
      <td>13.998353</td>
      <td>-599.787184</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2016-01-15 02:00:00</td>
      <td>6.055926</td>
      <td>10.213995</td>
      <td>5.383759</td>
      <td>42.657501</td>
      <td>68.116445</td>
      <td>10.507046</td>
      <td>0.953716</td>
      <td>16.208849</td>
      <td>2.257889</td>
      <td>...</td>
      <td>14.015015</td>
      <td>-502.520901</td>
      <td>11.912783</td>
      <td>-501.133383</td>
      <td>10.070913</td>
      <td>-500.129135</td>
      <td>8.013877</td>
      <td>-500.517572</td>
      <td>14.028663</td>
      <td>-601.427363</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2016-01-15 03:00:00</td>
      <td>6.047977</td>
      <td>9.977019</td>
      <td>4.858634</td>
      <td>42.689819</td>
      <td>68.347543</td>
      <td>10.422762</td>
      <td>0.883763</td>
      <td>16.532835</td>
      <td>2.146849</td>
      <td>...</td>
      <td>14.036510</td>
      <td>-500.857308</td>
      <td>11.999550</td>
      <td>-501.193686</td>
      <td>9.970366</td>
      <td>-499.201640</td>
      <td>7.977324</td>
      <td>-500.255908</td>
      <td>14.005551</td>
      <td>-599.996129</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2016-01-15 04:00:00</td>
      <td>6.148599</td>
      <td>10.142511</td>
      <td>4.939416</td>
      <td>42.774141</td>
      <td>66.927016</td>
      <td>10.360302</td>
      <td>0.792826</td>
      <td>16.525686</td>
      <td>2.055292</td>
      <td>...</td>
      <td>14.027298</td>
      <td>-499.838632</td>
      <td>11.953070</td>
      <td>-501.053894</td>
      <td>9.925709</td>
      <td>-501.686727</td>
      <td>7.894242</td>
      <td>-500.356035</td>
      <td>13.996647</td>
      <td>-601.496691</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 87 columns</p>
</div>




```python
data_train.duplicated().sum()
```




    0




```python
data_test = pd.read_csv('/datasets/gold_recovery_test_new.csv')
data_test.info()
data_test.head()
```

    <class 'pandas.core.frame.DataFrame'>
    RangeIndex: 5290 entries, 0 to 5289
    Data columns (total 53 columns):
     #   Column                                      Non-Null Count  Dtype  
    ---  ------                                      --------------  -----  
     0   date                                        5290 non-null   object 
     1   primary_cleaner.input.sulfate               5286 non-null   float64
     2   primary_cleaner.input.depressant            5285 non-null   float64
     3   primary_cleaner.input.feed_size             5290 non-null   float64
     4   primary_cleaner.input.xanthate              5286 non-null   float64
     5   primary_cleaner.state.floatbank8_a_air      5290 non-null   float64
     6   primary_cleaner.state.floatbank8_a_level    5290 non-null   float64
     7   primary_cleaner.state.floatbank8_b_air      5290 non-null   float64
     8   primary_cleaner.state.floatbank8_b_level    5290 non-null   float64
     9   primary_cleaner.state.floatbank8_c_air      5290 non-null   float64
     10  primary_cleaner.state.floatbank8_c_level    5290 non-null   float64
     11  primary_cleaner.state.floatbank8_d_air      5290 non-null   float64
     12  primary_cleaner.state.floatbank8_d_level    5290 non-null   float64
     13  rougher.input.feed_ag                       5290 non-null   float64
     14  rougher.input.feed_pb                       5290 non-null   float64
     15  rougher.input.feed_rate                     5287 non-null   float64
     16  rougher.input.feed_size                     5289 non-null   float64
     17  rougher.input.feed_sol                      5269 non-null   float64
     18  rougher.input.feed_au                       5290 non-null   float64
     19  rougher.input.floatbank10_sulfate           5285 non-null   float64
     20  rougher.input.floatbank10_xanthate          5290 non-null   float64
     21  rougher.input.floatbank11_sulfate           5282 non-null   float64
     22  rougher.input.floatbank11_xanthate          5265 non-null   float64
     23  rougher.state.floatbank10_a_air             5290 non-null   float64
     24  rougher.state.floatbank10_a_level           5290 non-null   float64
     25  rougher.state.floatbank10_b_air             5290 non-null   float64
     26  rougher.state.floatbank10_b_level           5290 non-null   float64
     27  rougher.state.floatbank10_c_air             5290 non-null   float64
     28  rougher.state.floatbank10_c_level           5290 non-null   float64
     29  rougher.state.floatbank10_d_air             5290 non-null   float64
     30  rougher.state.floatbank10_d_level           5290 non-null   float64
     31  rougher.state.floatbank10_e_air             5290 non-null   float64
     32  rougher.state.floatbank10_e_level           5290 non-null   float64
     33  rougher.state.floatbank10_f_air             5290 non-null   float64
     34  rougher.state.floatbank10_f_level           5290 non-null   float64
     35  secondary_cleaner.state.floatbank2_a_air    5287 non-null   float64
     36  secondary_cleaner.state.floatbank2_a_level  5290 non-null   float64
     37  secondary_cleaner.state.floatbank2_b_air    5288 non-null   float64
     38  secondary_cleaner.state.floatbank2_b_level  5290 non-null   float64
     39  secondary_cleaner.state.floatbank3_a_air    5281 non-null   float64
     40  secondary_cleaner.state.floatbank3_a_level  5290 non-null   float64
     41  secondary_cleaner.state.floatbank3_b_air    5290 non-null   float64
     42  secondary_cleaner.state.floatbank3_b_level  5290 non-null   float64
     43  secondary_cleaner.state.floatbank4_a_air    5290 non-null   float64
     44  secondary_cleaner.state.floatbank4_a_level  5290 non-null   float64
     45  secondary_cleaner.state.floatbank4_b_air    5290 non-null   float64
     46  secondary_cleaner.state.floatbank4_b_level  5290 non-null   float64
     47  secondary_cleaner.state.floatbank5_a_air    5290 non-null   float64
     48  secondary_cleaner.state.floatbank5_a_level  5290 non-null   float64
     49  secondary_cleaner.state.floatbank5_b_air    5290 non-null   float64
     50  secondary_cleaner.state.floatbank5_b_level  5290 non-null   float64
     51  secondary_cleaner.state.floatbank6_a_air    5290 non-null   float64
     52  secondary_cleaner.state.floatbank6_a_level  5290 non-null   float64
    dtypes: float64(52), object(1)
    memory usage: 2.1+ MB






<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>date</th>
      <th>primary_cleaner.input.sulfate</th>
      <th>primary_cleaner.input.depressant</th>
      <th>primary_cleaner.input.feed_size</th>
      <th>primary_cleaner.input.xanthate</th>
      <th>primary_cleaner.state.floatbank8_a_air</th>
      <th>primary_cleaner.state.floatbank8_a_level</th>
      <th>primary_cleaner.state.floatbank8_b_air</th>
      <th>primary_cleaner.state.floatbank8_b_level</th>
      <th>primary_cleaner.state.floatbank8_c_air</th>
      <th>...</th>
      <th>secondary_cleaner.state.floatbank4_a_air</th>
      <th>secondary_cleaner.state.floatbank4_a_level</th>
      <th>secondary_cleaner.state.floatbank4_b_air</th>
      <th>secondary_cleaner.state.floatbank4_b_level</th>
      <th>secondary_cleaner.state.floatbank5_a_air</th>
      <th>secondary_cleaner.state.floatbank5_a_level</th>
      <th>secondary_cleaner.state.floatbank5_b_air</th>
      <th>secondary_cleaner.state.floatbank5_b_level</th>
      <th>secondary_cleaner.state.floatbank6_a_air</th>
      <th>secondary_cleaner.state.floatbank6_a_level</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2016-09-01 00:59:59</td>
      <td>210.800909</td>
      <td>14.993118</td>
      <td>8.080000</td>
      <td>1.005021</td>
      <td>1398.981301</td>
      <td>-500.225577</td>
      <td>1399.144926</td>
      <td>-499.919735</td>
      <td>1400.102998</td>
      <td>...</td>
      <td>12.023554</td>
      <td>-497.795834</td>
      <td>8.016656</td>
      <td>-501.289139</td>
      <td>7.946562</td>
      <td>-432.317850</td>
      <td>4.872511</td>
      <td>-500.037437</td>
      <td>26.705889</td>
      <td>-499.709414</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2016-09-01 01:59:59</td>
      <td>215.392455</td>
      <td>14.987471</td>
      <td>8.080000</td>
      <td>0.990469</td>
      <td>1398.777912</td>
      <td>-500.057435</td>
      <td>1398.055362</td>
      <td>-499.778182</td>
      <td>1396.151033</td>
      <td>...</td>
      <td>12.058140</td>
      <td>-498.695773</td>
      <td>8.130979</td>
      <td>-499.634209</td>
      <td>7.958270</td>
      <td>-525.839648</td>
      <td>4.878850</td>
      <td>-500.162375</td>
      <td>25.019940</td>
      <td>-499.819438</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2016-09-01 02:59:59</td>
      <td>215.259946</td>
      <td>12.884934</td>
      <td>7.786667</td>
      <td>0.996043</td>
      <td>1398.493666</td>
      <td>-500.868360</td>
      <td>1398.860436</td>
      <td>-499.764529</td>
      <td>1398.075709</td>
      <td>...</td>
      <td>11.962366</td>
      <td>-498.767484</td>
      <td>8.096893</td>
      <td>-500.827423</td>
      <td>8.071056</td>
      <td>-500.801673</td>
      <td>4.905125</td>
      <td>-499.828510</td>
      <td>24.994862</td>
      <td>-500.622559</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2016-09-01 03:59:59</td>
      <td>215.336236</td>
      <td>12.006805</td>
      <td>7.640000</td>
      <td>0.863514</td>
      <td>1399.618111</td>
      <td>-498.863574</td>
      <td>1397.440120</td>
      <td>-499.211024</td>
      <td>1400.129303</td>
      <td>...</td>
      <td>12.033091</td>
      <td>-498.350935</td>
      <td>8.074946</td>
      <td>-499.474407</td>
      <td>7.897085</td>
      <td>-500.868509</td>
      <td>4.931400</td>
      <td>-499.963623</td>
      <td>24.948919</td>
      <td>-498.709987</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2016-09-01 04:59:59</td>
      <td>199.099327</td>
      <td>10.682530</td>
      <td>7.530000</td>
      <td>0.805575</td>
      <td>1401.268123</td>
      <td>-500.808305</td>
      <td>1398.128818</td>
      <td>-499.504543</td>
      <td>1402.172226</td>
      <td>...</td>
      <td>12.025367</td>
      <td>-500.786497</td>
      <td>8.054678</td>
      <td>-500.397500</td>
      <td>8.107890</td>
      <td>-509.526725</td>
      <td>4.957674</td>
      <td>-500.360026</td>
      <td>25.003331</td>
      <td>-500.856333</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 53 columns</p>
</div>




```python
data_test.duplicated().sum()
```




    0




```python
data_full = pd.read_csv('/datasets/gold_recovery_full_new.csv')
data_full.info()
data_full.head()
```

    <class 'pandas.core.frame.DataFrame'>
    RangeIndex: 19439 entries, 0 to 19438
    Data columns (total 87 columns):
     #   Column                                              Non-Null Count  Dtype  
    ---  ------                                              --------------  -----  
     0   date                                                19439 non-null  object 
     1   final.output.concentrate_ag                         19438 non-null  float64
     2   final.output.concentrate_pb                         19438 non-null  float64
     3   final.output.concentrate_sol                        19228 non-null  float64
     4   final.output.concentrate_au                         19439 non-null  float64
     5   final.output.recovery                               19439 non-null  float64
     6   final.output.tail_ag                                19438 non-null  float64
     7   final.output.tail_pb                                19338 non-null  float64
     8   final.output.tail_sol                               19433 non-null  float64
     9   final.output.tail_au                                19439 non-null  float64
     10  primary_cleaner.input.sulfate                       19415 non-null  float64
     11  primary_cleaner.input.depressant                    19402 non-null  float64
     12  primary_cleaner.input.feed_size                     19439 non-null  float64
     13  primary_cleaner.input.xanthate                      19335 non-null  float64
     14  primary_cleaner.output.concentrate_ag               19439 non-null  float64
     15  primary_cleaner.output.concentrate_pb               19323 non-null  float64
     16  primary_cleaner.output.concentrate_sol              19069 non-null  float64
     17  primary_cleaner.output.concentrate_au               19439 non-null  float64
     18  primary_cleaner.output.tail_ag                      19435 non-null  float64
     19  primary_cleaner.output.tail_pb                      19418 non-null  float64
     20  primary_cleaner.output.tail_sol                     19377 non-null  float64
     21  primary_cleaner.output.tail_au                      19439 non-null  float64
     22  primary_cleaner.state.floatbank8_a_air              19435 non-null  float64
     23  primary_cleaner.state.floatbank8_a_level            19438 non-null  float64
     24  primary_cleaner.state.floatbank8_b_air              19435 non-null  float64
     25  primary_cleaner.state.floatbank8_b_level            19438 non-null  float64
     26  primary_cleaner.state.floatbank8_c_air              19437 non-null  float64
     27  primary_cleaner.state.floatbank8_c_level            19438 non-null  float64
     28  primary_cleaner.state.floatbank8_d_air              19436 non-null  float64
     29  primary_cleaner.state.floatbank8_d_level            19438 non-null  float64
     30  rougher.calculation.sulfate_to_au_concentrate       19437 non-null  float64
     31  rougher.calculation.floatbank10_sulfate_to_au_feed  19437 non-null  float64
     32  rougher.calculation.floatbank11_sulfate_to_au_feed  19437 non-null  float64
     33  rougher.calculation.au_pb_ratio                     19439 non-null  float64
     34  rougher.input.feed_ag                               19439 non-null  float64
     35  rougher.input.feed_pb                               19339 non-null  float64
     36  rougher.input.feed_rate                             19428 non-null  float64
     37  rougher.input.feed_size                             19294 non-null  float64
     38  rougher.input.feed_sol                              19340 non-null  float64
     39  rougher.input.feed_au                               19439 non-null  float64
     40  rougher.input.floatbank10_sulfate                   19405 non-null  float64
     41  rougher.input.floatbank10_xanthate                  19431 non-null  float64
     42  rougher.input.floatbank11_sulfate                   19395 non-null  float64
     43  rougher.input.floatbank11_xanthate                  18986 non-null  float64
     44  rougher.output.concentrate_ag                       19439 non-null  float64
     45  rougher.output.concentrate_pb                       19439 non-null  float64
     46  rougher.output.concentrate_sol                      19416 non-null  float64
     47  rougher.output.concentrate_au                       19439 non-null  float64
     48  rougher.output.recovery                             19439 non-null  float64
     49  rougher.output.tail_ag                              19438 non-null  float64
     50  rougher.output.tail_pb                              19439 non-null  float64
     51  rougher.output.tail_sol                             19439 non-null  float64
     52  rougher.output.tail_au                              19439 non-null  float64
     53  rougher.state.floatbank10_a_air                     19438 non-null  float64
     54  rougher.state.floatbank10_a_level                   19438 non-null  float64
     55  rougher.state.floatbank10_b_air                     19438 non-null  float64
     56  rougher.state.floatbank10_b_level                   19438 non-null  float64
     57  rougher.state.floatbank10_c_air                     19438 non-null  float64
     58  rougher.state.floatbank10_c_level                   19438 non-null  float64
     59  rougher.state.floatbank10_d_air                     19439 non-null  float64
     60  rougher.state.floatbank10_d_level                   19439 non-null  float64
     61  rougher.state.floatbank10_e_air                     19003 non-null  float64
     62  rougher.state.floatbank10_e_level                   19439 non-null  float64
     63  rougher.state.floatbank10_f_air                     19439 non-null  float64
     64  rougher.state.floatbank10_f_level                   19439 non-null  float64
     65  secondary_cleaner.output.tail_ag                    19437 non-null  float64
     66  secondary_cleaner.output.tail_pb                    19427 non-null  float64
     67  secondary_cleaner.output.tail_sol                   17691 non-null  float64
     68  secondary_cleaner.output.tail_au                    19439 non-null  float64
     69  secondary_cleaner.state.floatbank2_a_air            19219 non-null  float64
     70  secondary_cleaner.state.floatbank2_a_level          19438 non-null  float64
     71  secondary_cleaner.state.floatbank2_b_air            19416 non-null  float64
     72  secondary_cleaner.state.floatbank2_b_level          19438 non-null  float64
     73  secondary_cleaner.state.floatbank3_a_air            19426 non-null  float64
     74  secondary_cleaner.state.floatbank3_a_level          19438 non-null  float64
     75  secondary_cleaner.state.floatbank3_b_air            19438 non-null  float64
     76  secondary_cleaner.state.floatbank3_b_level          19438 non-null  float64
     77  secondary_cleaner.state.floatbank4_a_air            19433 non-null  float64
     78  secondary_cleaner.state.floatbank4_a_level          19438 non-null  float64
     79  secondary_cleaner.state.floatbank4_b_air            19438 non-null  float64
     80  secondary_cleaner.state.floatbank4_b_level          19438 non-null  float64
     81  secondary_cleaner.state.floatbank5_a_air            19438 non-null  float64
     82  secondary_cleaner.state.floatbank5_a_level          19438 non-null  float64
     83  secondary_cleaner.state.floatbank5_b_air            19438 non-null  float64
     84  secondary_cleaner.state.floatbank5_b_level          19438 non-null  float64
     85  secondary_cleaner.state.floatbank6_a_air            19437 non-null  float64
     86  secondary_cleaner.state.floatbank6_a_level          19438 non-null  float64
    dtypes: float64(86), object(1)
    memory usage: 12.9+ MB






<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>date</th>
      <th>final.output.concentrate_ag</th>
      <th>final.output.concentrate_pb</th>
      <th>final.output.concentrate_sol</th>
      <th>final.output.concentrate_au</th>
      <th>final.output.recovery</th>
      <th>final.output.tail_ag</th>
      <th>final.output.tail_pb</th>
      <th>final.output.tail_sol</th>
      <th>final.output.tail_au</th>
      <th>...</th>
      <th>secondary_cleaner.state.floatbank4_a_air</th>
      <th>secondary_cleaner.state.floatbank4_a_level</th>
      <th>secondary_cleaner.state.floatbank4_b_air</th>
      <th>secondary_cleaner.state.floatbank4_b_level</th>
      <th>secondary_cleaner.state.floatbank5_a_air</th>
      <th>secondary_cleaner.state.floatbank5_a_level</th>
      <th>secondary_cleaner.state.floatbank5_b_air</th>
      <th>secondary_cleaner.state.floatbank5_b_level</th>
      <th>secondary_cleaner.state.floatbank6_a_air</th>
      <th>secondary_cleaner.state.floatbank6_a_level</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2016-01-15 00:00:00</td>
      <td>6.055403</td>
      <td>9.889648</td>
      <td>5.507324</td>
      <td>42.192020</td>
      <td>70.541216</td>
      <td>10.411962</td>
      <td>0.895447</td>
      <td>16.904297</td>
      <td>2.143149</td>
      <td>...</td>
      <td>14.016835</td>
      <td>-502.488007</td>
      <td>12.099931</td>
      <td>-504.715942</td>
      <td>9.925633</td>
      <td>-498.310211</td>
      <td>8.079666</td>
      <td>-500.470978</td>
      <td>14.151341</td>
      <td>-605.841980</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2016-01-15 01:00:00</td>
      <td>6.029369</td>
      <td>9.968944</td>
      <td>5.257781</td>
      <td>42.701629</td>
      <td>69.266198</td>
      <td>10.462676</td>
      <td>0.927452</td>
      <td>16.634514</td>
      <td>2.224930</td>
      <td>...</td>
      <td>13.992281</td>
      <td>-505.503262</td>
      <td>11.950531</td>
      <td>-501.331529</td>
      <td>10.039245</td>
      <td>-500.169983</td>
      <td>7.984757</td>
      <td>-500.582168</td>
      <td>13.998353</td>
      <td>-599.787184</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2016-01-15 02:00:00</td>
      <td>6.055926</td>
      <td>10.213995</td>
      <td>5.383759</td>
      <td>42.657501</td>
      <td>68.116445</td>
      <td>10.507046</td>
      <td>0.953716</td>
      <td>16.208849</td>
      <td>2.257889</td>
      <td>...</td>
      <td>14.015015</td>
      <td>-502.520901</td>
      <td>11.912783</td>
      <td>-501.133383</td>
      <td>10.070913</td>
      <td>-500.129135</td>
      <td>8.013877</td>
      <td>-500.517572</td>
      <td>14.028663</td>
      <td>-601.427363</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2016-01-15 03:00:00</td>
      <td>6.047977</td>
      <td>9.977019</td>
      <td>4.858634</td>
      <td>42.689819</td>
      <td>68.347543</td>
      <td>10.422762</td>
      <td>0.883763</td>
      <td>16.532835</td>
      <td>2.146849</td>
      <td>...</td>
      <td>14.036510</td>
      <td>-500.857308</td>
      <td>11.999550</td>
      <td>-501.193686</td>
      <td>9.970366</td>
      <td>-499.201640</td>
      <td>7.977324</td>
      <td>-500.255908</td>
      <td>14.005551</td>
      <td>-599.996129</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2016-01-15 04:00:00</td>
      <td>6.148599</td>
      <td>10.142511</td>
      <td>4.939416</td>
      <td>42.774141</td>
      <td>66.927016</td>
      <td>10.360302</td>
      <td>0.792826</td>
      <td>16.525686</td>
      <td>2.055292</td>
      <td>...</td>
      <td>14.027298</td>
      <td>-499.838632</td>
      <td>11.953070</td>
      <td>-501.053894</td>
      <td>9.925709</td>
      <td>-501.686727</td>
      <td>7.894242</td>
      <td>-500.356035</td>
      <td>13.996647</td>
      <td>-601.496691</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 87 columns</p>
</div>




```python
data_full.duplicated().sum()
```




    0



Явных дубликатов нет


1.2. Проверьте, что эффективность обогащения рассчитана правильно. Вычислите её на обучающей выборке для признака rougher.output.recovery. Найдите MAE между вашими расчётами и значением признака. Опишите выводы.

R=C*(F-T)/(F*(C-T))*100%


```python
target = data_train['rougher.output.recovery']
target.describe()
```




    count    14149.000000
    mean        82.704502
    std         14.479156
    min          0.000000
    25%         79.993067
    50%         85.299462
    75%         90.165021
    max        100.000000
    Name: rougher.output.recovery, dtype: float64




```python
def recovery(data):
    c= data['rougher.output.concentrate_au']
    f= data['rougher.input.feed_au']
    t= data['rougher.output.tail_au']
    r= c*(f-t) / (f*(c-t))*100
    
    data['control'] = abs(r)
```




```python
recovery(data_train)
```


```python
predictions = data_train['control']
data_train['control'].describe()
```




    count    14149.000000
    mean        82.704502
    std         14.479156
    min          0.000000
    25%         79.993067
    50%         85.299462
    75%         90.165021
    max        100.000000
    Name: control, dtype: float64




```python

```


```python
mean_absolute_error(target, predictions).round(15)
```




    1e-14



MAE практически равна нулю, а значит, расчеты верны



1.3. Проанализируйте признаки, недоступные в тестовой выборке. Что это за параметры? К какому типу относятся?


```python
missed_signs = set(data_train.columns) - set(data_test.columns)
missed_signs
```




    {'control',
     'final.output.concentrate_ag',
     'final.output.concentrate_au',
     'final.output.concentrate_pb',
     'final.output.concentrate_sol',
     'final.output.recovery',
     'final.output.tail_ag',
     'final.output.tail_au',
     'final.output.tail_pb',
     'final.output.tail_sol',
     'primary_cleaner.output.concentrate_ag',
     'primary_cleaner.output.concentrate_au',
     'primary_cleaner.output.concentrate_pb',
     'primary_cleaner.output.concentrate_sol',
     'primary_cleaner.output.tail_ag',
     'primary_cleaner.output.tail_au',
     'primary_cleaner.output.tail_pb',
     'primary_cleaner.output.tail_sol',
     'rougher.calculation.au_pb_ratio',
     'rougher.calculation.floatbank10_sulfate_to_au_feed',
     'rougher.calculation.floatbank11_sulfate_to_au_feed',
     'rougher.calculation.sulfate_to_au_concentrate',
     'rougher.output.concentrate_ag',
     'rougher.output.concentrate_au',
     'rougher.output.concentrate_pb',
     'rougher.output.concentrate_sol',
     'rougher.output.recovery',
     'rougher.output.tail_ag',
     'rougher.output.tail_au',
     'rougher.output.tail_pb',
     'rougher.output.tail_sol',
     'secondary_cleaner.output.tail_ag',
     'secondary_cleaner.output.tail_au',
     'secondary_cleaner.output.tail_pb',
     'secondary_cleaner.output.tail_sol'}



output - 30 (параметры продукта)
calculation - 4 (расчётные характеристики)

В тестовой выборке отсутствуют 34 значения. Это может быть связано с тем, что они рассчитываются на более поздних стадиях.



1.4. Проведите предобработку данных.

Добавим в тестовую выборку целевые признаки rougher.output.recovery и final.output.recovery


```python
data_test = data_test.merge(data_full.loc[:, ['date','rougher.output.recovery','final.output.recovery']], on='date')
```



Удалим колонку date, так как она не нужна для дальнейшего обучения модели.


```python
data_train = data_train.drop('date', axis=1)
data_test = data_test.drop('date', axis=1)
```

Обработаем пропуски


```python
data_train = data_train.fillna(method='bfill')
data_test = data_test.fillna(method='bfill')
```



## Анализ данных

2.1. Посмотрите, как меняется концентрация металлов (Au, Ag, Pb) на различных этапах очистки. Опишите выводы.


```python
position = 0
plt.figure(figsize=[15, 10])
plt.subplots_adjust(top=1, wspace=0.2, hspace=0.3)
plt.suptitle('Концентрация металлов (Au, Ag, Pb) на различных этапах очистки', fontsize=10)
for metal in ['au', 'ag', 'pb']:
    position += 1
    plt.subplot(3, 1, position)
    plt.title(f'Концентрация металла {str(metal).upper()} на различных этапах очистки', fontsize=10)
    sns.set_style('darkgrid')
    sns.histplot(data_train[f'rougher.input.feed_{metal}'], color='y', label='Сырье', kde=False)
    sns.histplot(data_train[f'rougher.output.concentrate_{metal}'], color='b', label='Флотация', kde=False)
    sns.histplot(data_train[f'primary_cleaner.output.concentrate_{metal}'], color='r', label='Первичная очистка', kde=False)
    sns.histplot(data_train[f'final.output.concentrate_{metal}'], color='g', label='Финальная концетрация',kde=False)
    plt.xlabel('Концентрация металла')
    plt.ylabel('Гранулы')
    plt.legend()
plt.show()
```


    
![png](output_45_0.png)
    


Самый главный показатель - концентрация золота - растет с каждым этапом, доля серебра на этапе флотации возрастает, но к финалу падает, содержание свинца растет до первичной очистки и в финальном концентрате не меняется.



2.2.  Сравните распределения размеров гранул сырья на обучающей и тестовой выборках. Если распределения сильно отличаются друг от друга, оценка модели будет неправильной.


```python
data_train['rougher.input.feed_size'].hist(bins=30, figsize=(7,5), density=True)
data_test['rougher.input.feed_size'].hist(bins=30, density=True)

plt.legend(['train','test'])
plt.xlabel('Распределение размеров гранул сырья')
plt.ylabel('Доля гранул')
plt.show()
```


    
![png](output_51_0.png)
    


Распределения похожи, значит, модель будет работать нормально.



2.3. Исследуйте суммарную концентрацию металлов на разных стадиях: в сырье, в черновом концентрате и в финальном концентрате.


```python
def total_concentration(data, concentrat_ag, concentrat_au, concentrat_pb):
    ag = data[concentrat_ag]
    au = data[concentrat_au]
    pb = data[concentrat_pb]
    concentration = ag + au + pb
    
    plt.figure(figsize=(7,5))
    concentration.plot.hist(bins=50)
    plt.title('Cуммарная концентрация металлов')
    plt.xlabel('Концентрация')
    plt.ylabel('Гранулы')
    plt.grid(True)
    plt.show()
    print(concentration.mean())
```

В сырье


```python
total_concentration(data_full,'rougher.input.feed_ag','rougher.input.feed_au','rougher.input.feed_pb')
```


    
![png](output_59_0.png)
    


    20.7041235131825


В черновом концентрате


```python
total_concentration(data_full,'rougher.output.concentrate_ag','rougher.output.concentrate_au','rougher.output.concentrate_pb')
```


    
![png](output_61_0.png)
    


    39.37303181255475


В финальном концентрате


```python
total_concentration(data_full,'final.output.concentrate_ag','final.output.concentrate_au','final.output.concentrate_pb')
```


    
![png](output_63_0.png)
    


    59.22465277662747


Концентрация увеличивается на каждой стадии, также на графиках видны выбросы. Их следует удалить.


```python
data_train = data_train[(data_train['rougher.input.feed_ag'] >= 1) &
            (data_train['rougher.input.feed_pb'] >= 1) &
            (data_train['rougher.input.feed_au'] >= 1) &
            (data_train['rougher.output.concentrate_ag'] >= 1) &
            (data_train['rougher.output.concentrate_pb'] >= 1) &
            (data_train['rougher.output.concentrate_au'] >= 1) &
            (data_train['primary_cleaner.output.concentrate_ag'] >= 1) &
            (data_train['primary_cleaner.output.concentrate_pb'] >= 1) &
            (data_train['primary_cleaner.output.concentrate_au'] >= 1) &
            (data_train['final.output.concentrate_ag'] >= 1) &
            (data_train['final.output.concentrate_pb'] >= 1) &
            (data_train['final.output.concentrate_au'] >= 1)]
```




```python
data_train.shape
```




    (13428, 87)





## Модель

3.1. Напишите функцию для вычисления итоговой sMAPE.


```python
def smape_calc(target, predict):
    smape = np.mean(abs(target - predict) / ((abs(target) + abs(predict)) / 2)) * 100
    return smape

def final_smape_calc(smape_rougher, smape_final):
    return (0.25*smape_rougher + 0.75*smape_final)
```



3.2. Обучите разные модели и оцените их качество кросс-валидацией. Выберите лучшую модель и проверьте её на тестовой выборке. Опишите выводы

Удалим целевые признаки из обучающей выборки, чтобы она соответствовала тестовой. Кроме 'final.output.recovery' и'rougher.output.recovery'


```python
#data_train = data_test.merge(data_test.loc[:, ['rougher.output.recovery','final.output.recovery']])
```


```python
data_train = data_train[data_test.columns]
```




```python
data_train.shape
```




    (13428, 54)




```python
data_test.shape
```




    (5290, 54)






```python
features_train = data_train.drop(['rougher.output.recovery','final.output.recovery'], axis=1)
target_train_rougher = data_train['rougher.output.recovery']
target_train_final = data_train['final.output.recovery']

for sample in [features_train, target_train_rougher, target_train_final]:
    print(sample.shape)
```

    (13428, 52)
    (13428,)
    (13428,)





```python
score = make_scorer(smape_calc, greater_is_better = False) 

model_rfr = make_pipeline(StandardScaler(), RandomForestRegressor())
model_dtr = make_pipeline(StandardScaler(), DecisionTreeRegressor())
```



```python
parameters_rfr = {'randomforestregressor__n_estimators':[1,100],
                  'randomforestregressor__max_depth':[1,10],
                  'randomforestregressor__random_state':[12345]}

parameters_dtr = {'decisiontreeregressor__max_depth':[1,10]}
```


```python
grid_rougher_rfr = GridSearchCV(model_rfr, param_grid=parameters_rfr, cv=5, scoring=score)
grid_final_rfr = GridSearchCV(model_rfr, param_grid=parameters_rfr, cv=5, scoring=score)

grid_rougher_dtr = GridSearchCV(model_dtr, param_grid=parameters_dtr, cv=5, scoring=score)
grid_final_dtr = GridSearchCV(model_dtr, param_grid=parameters_dtr, cv=5, scoring=score)
```


```python
grid_rougher_rfr.fit(features_train, target_train_rougher)
grid_final_rfr.fit(features_train, target_train_final)

grid_rougher_dtr.fit(features_train, target_train_rougher)
grid_final_dtr.fit(features_train, target_train_final)
```




    GridSearchCV(cv=5,
                 estimator=Pipeline(steps=[('standardscaler', StandardScaler()),
                                           ('decisiontreeregressor',
                                            DecisionTreeRegressor())]),
                 param_grid={'decisiontreeregressor__max_depth': [1, 10]},
                 scoring=make_scorer(smape_calc, greater_is_better=False))




```python
best_score_rougher_rfr = grid_rougher_rfr.best_score_
best_score_final_rfr = grid_final_rfr.best_score_

best_score_rougher_dtr = grid_rougher_dtr.best_score_
best_score_final_dtr = grid_final_dtr.best_score_

print('RandomForestRegressor  для rougher:', best_score_rougher_rfr)
print('DecisionTreeRegressor для rougher:', best_score_rougher_dtr)

print()
print('RandomForestRegressor для final:', best_score_final_rfr)
print('DecisionTreeRegressor для final:', best_score_final_dtr)
```

    RandomForestRegressor  для rougher: -6.197668052085769
    DecisionTreeRegressor для rougher: -7.313314840963914
    
    RandomForestRegressor для final: -9.230246770330774
    DecisionTreeRegressor для final: -9.4813101494797



```python
final_smape_rfr = final_smape_calc(best_score_rougher_rfr, best_score_final_rfr)
print('Итоговое sMAPE для RandomForestRegressor:', final_smape_rfr)

final_smape_dtr = final_smape_calc(best_score_rougher_dtr, best_score_final_dtr)
print('Итоговое sMAPE для DecisionTreeRegressor:', final_smape_dtr)
```

    Итоговое sMAPE для RandomForestRegressor: -8.472102090769523
    Итоговое sMAPE для DecisionTreeRegressor: -8.939311322350754




Вывод: лучшие показатели у модели RandomForestRegressor. Ее и проверим на тестовой выборке.


```python
features_test = data_test.drop(['rougher.output.recovery', 'final.output.recovery'], axis=1)
target_test_rougher = data_test['rougher.output.recovery']
target_test_final = data_test['final.output.recovery']

test_rougher = grid_rougher_rfr.predict(features_test) 
test_final = grid_final_rfr.predict(features_test)

rougher_smape_test = smape_calc(target_test_rougher, test_rougher)
final_smape_test = smape_calc(target_test_final, test_final)

final_smape = final_smape_calc(rougher_smape_test, final_smape_test)
print('sMAPE =', final_smape)
```

    sMAPE = 9.15352069693996





```python
dummy_rougher = DummyRegressor(strategy='mean')
dummy_final = DummyRegressor(strategy='mean')
    
dummy_rougher.fit(features_train, target_train_rougher)
dummy_final.fit(features_train, target_train_final)
    
rougher = dummy_rougher.predict(data_test)
final = dummy_final.predict(data_test)
    
final_smape = final_smape_calc(smape_calc(target_test_rougher, rougher),
                                   smape_calc(target_test_final, final))

print('итоговая sMAPE =', final_smape)
```

    итоговая sMAPE = 9.807098186879902




Вывод: Наша задача заключалась в том, чтобы создать оптимальную модель, которая должна предсказать коэффициент восстановления золота из золотосодержащей руды. После обработки данных модели были изучены с помощью кроссвалидации и поиска гиперпараметров GridSearchCV. Была написана функция для вычисления sMAPE.
Лучшая модель - RandomForestRegressor (sMaPE = 8.47). Она была проверена на тестовой выборке (sMaPE = 9.15). Затем нами было проведено сравнение с DummyRegressor (sMaPE = 9.81). sMAPE на тестовой выборке меньше, чем на константной модели, значит, наша модель прогнозирует лучше случайной.

