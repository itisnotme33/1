
# –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≤–æ–∑—Ä–∞—Å—Ç–∞ –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–π

# –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞


–°–µ—Ç–µ–≤–æ–π —Å—É–ø–µ—Ä–º–∞—Ä–∫–µ—Ç ¬´–•–ª–µ–±-–°–æ–ª—å¬ª –≤–Ω–µ–¥—Ä—è–µ—Ç —Å–∏—Å—Ç–µ–º—É –∫–æ–º–ø—å—é—Ç–µ—Ä–Ω–æ–≥–æ –∑—Ä–µ–Ω–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–π. –§–æ—Ç–æ—Ñ–∏–∫—Å–∞—Ü–∏—è –≤ –ø—Ä–∏–∫–∞—Å—Å–æ–≤–æ–π –∑–æ–Ω–µ –ø–æ–º–æ–∂–µ—Ç –æ–ø—Ä–µ–¥–µ–ª—è—Ç—å –≤–æ–∑—Ä–∞—Å—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤, —á—Ç–æ–±—ã:
–ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–æ–∫—É–ø–∫–∏ –∏ –ø—Ä–µ–¥–ª–∞–≥–∞—Ç—å —Ç–æ–≤–∞—Ä—ã, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –∑–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞—Ç—å –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–π —ç—Ç–æ–π –≤–æ–∑—Ä–∞—Å—Ç–Ω–æ–π –≥—Ä—É–ø–ø—ã;
–ö–æ–Ω—Ç—Ä–æ–ª–∏—Ä–æ–≤–∞—Ç—å –¥–æ–±—Ä–æ—Å–æ–≤–µ—Å—Ç–Ω–æ—Å—Ç—å –∫–∞—Å—Å–∏—Ä–æ–≤ –ø—Ä–∏ –ø—Ä–æ–¥–∞–∂–µ –∞–ª–∫–æ–≥–æ–ª—è.
–ü–æ—Å—Ç—Ä–æ–π—Ç–µ –º–æ–¥–µ–ª—å, –∫–æ—Ç–æ—Ä–∞—è –ø–æ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç –ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω—ã–π –≤–æ–∑—Ä–∞—Å—Ç —á–µ–ª–æ–≤–µ–∫–∞. –í –≤–∞—à–µ–º —Ä–∞—Å–ø–æ—Ä—è–∂–µ–Ω–∏–∏ –Ω–∞–±–æ—Ä —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –ª—é–¥–µ–π —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –≤–æ–∑—Ä–∞—Å—Ç–∞.

## –ò—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö


```python
import pandas as pd
from tensorflow.keras import Sequential
from tensorflow.keras.layers import Conv2D, Flatten, Dense, GlobalAveragePooling2D
import matplotlib.pyplot as plt
import numpy as np
from tensorflow.keras.applications.resnet import ResNet50
from tensorflow.keras.preprocessing.image import ImageDataGenerator
from tensorflow.keras.optimizers import Adam
```

<div style="border:solid purple 5px; padding: 20px"> 
<h2 align="center"> –†—É–±—Ä–∏–∫–∞ ¬´–ü–∏—Ç–æ–Ω—è—á–∏–π –ª–∞–π—Ñ—Ö–∞–∫–µ—Ä¬ª <a class="tocSkip"> </h2>

<h3> –®–∏—Ä–æ–∫–æ—Ñ–æ—Ä–º–∞—Ç–Ω—ã–π Jupyter <a class="tocSkip"> </h3>

–†–∞—Å—à–∏—Ä—è–µ–º –≥—Ä–∞–Ω–∏—Ü—ã, –∏–ª–∏ –∫–∞–∫ —Å–¥–µ–ª–∞—Ç—å —Ä–∞–±–æ—Ç—É –±–æ–ª–µ–µ –∫–æ–º—Ñ–æ—Ä—Ç–Ω–æ–π (–Ω–µ –≤—Å–µ–º –Ω—Ä–∞–≤–∏—Ç—Å—è üòÑ)

¬†¬†¬† from IPython.core.display import display, HTML
¬†¬†¬† display(HTML("<style>.container { width:90% !important; }</style>"))


```python
labels = pd.read_csv('/datasets/faces/labels.csv')
train_datagen = ImageDataGenerator(rescale=1/255)
train_gen_flow = train_datagen.flow_from_dataframe(
        dataframe=labels,
        directory='/datasets/faces/final_files/',
        x_col='file_name',
        y_col='real_age',
        target_size=(224, 224),
        batch_size=32,
        class_mode='raw',
        seed=12345)
```

    Found 7591 validated image filenames.




```python
labels.shape
```




    (7591, 2)




```python
labels.head()
```





<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>file_name</th>
      <th>real_age</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>000000.jpg</td>
      <td>4</td>
    </tr>
    <tr>
      <th>1</th>
      <td>000001.jpg</td>
      <td>18</td>
    </tr>
    <tr>
      <th>2</th>
      <td>000002.jpg</td>
      <td>80</td>
    </tr>
    <tr>
      <th>3</th>
      <td>000003.jpg</td>
      <td>50</td>
    </tr>
    <tr>
      <th>4</th>
      <td>000004.jpg</td>
      <td>17</td>
    </tr>
  </tbody>
</table>
</div>




```python
labels.info()
```

    <class 'pandas.core.frame.DataFrame'>
    RangeIndex: 7591 entries, 0 to 7590
    Data columns (total 2 columns):
     #   Column     Non-Null Count  Dtype 
    ---  ------     --------------  ----- 
     0   file_name  7591 non-null   object
     1   real_age   7591 non-null   int64 
    dtypes: int64(1), object(1)
    memory usage: 118.7+ KB



```python
labels.hist(bins=50)
plt.title('–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≤–æ–∑—Ä–∞—Å—Ç–∞ –≤ –≤—ã–±–æ—Ä–∫–µ')
plt.xlabel('–í–æ–∑—Ä–∞—Å—Ç')
plt.ylabel('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–µ–ª–æ–≤–µ–∫')
plt.show()
```


    
![png](output_13_0.png)
    


–ù–∞ –≥–∏—Å—Ç–æ–≥—Ä–∞–º–º–µ –≤–∏–¥–∏–º, —á—Ç–æ –±–æ–ª—å—à–∞—è —á–∞—Å—Ç—å —Ñ–æ—Ç–æ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç –ª—é–¥—è–º –æ—Ç 20 –¥–æ 40 –ª–µ—Ç (–ø–∏–∫–∏ –ø—Ä–∏—Ö–æ–¥—è—Ç—Å—è –Ω–∞ 25-30 –ª–µ—Ç), —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ, –∏ —Ç–æ—á–Ω–æ—Å—Ç—å —É –º–æ–¥–µ–ª–∏ –≤ —ç—Ç–æ–º –¥–∏–ø–∞–∑–æ–Ω–µ –±—É–¥–µ—Ç –≤—ã—à–µ.



```python
features, target = next(train_gen_flow)

fig = plt.figure(figsize=(10,10))
for i in range(16):
    fig.add_subplot(4, 4, i+1)
    plt.imshow(features[i])
    plt.title(target[i])
    plt.xticks([])
    plt.yticks([])
    plt.tight_layout()
```


    
![png](output_16_0.png)
    


–í—Å–µ–≥–æ –∏–º–µ–µ—Ç—Å—è —á—É—Ç—å –±–æ–ª–µ–µ 7500 —Å–Ω–∏–º–∫–æ–≤ —Ä–∞–∑–º–µ—Ä–∞ 224*224. –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –≤ —Ü–µ–ª–æ–º —Ö–æ—Ä–æ—à–µ–≥–æ –∫–∞—á–µ—Å—Ç–≤–∞, –æ–¥–Ω–∞–∫–æ –≤—Å—Ç—Ä–µ—á–∞—é—Ç—Å—è –∏ —á–µ—Ä–Ω–æ-–±–µ–ª—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è.


## –û–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏

–ü–µ—Ä–µ–Ω–µ—Å–∏—Ç–µ —Å—é–¥–∞ –∫–æ–¥ –æ–±—É—á–µ–Ω–∏—è –º–æ–¥–µ–ª–∏ –∏ –µ—ë —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤—ã–≤–æ–¥–∞ –Ω–∞ —ç–∫—Ä–∞–Ω.


(–ö–æ–¥ –≤ —ç—Ç–æ–º —Ä–∞–∑–¥–µ–ª–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º GPU-—Ç—Ä–µ–Ω–∞–∂—ë—Ä–µ, –ø–æ—ç—Ç–æ–º—É –æ—Ñ–æ—Ä–º–ª–µ–Ω –Ω–µ –∫–∞–∫ —è—á–µ–π–∫–∞ —Å –∫–æ–¥–æ–º, –∞ –∫–∞–∫ –∫–æ–¥ –≤ —Ç–µ–∫—Å—Ç–æ–≤–æ–π —è—á–µ–π–∫–µ)

<div style="border:solid purple 5px; padding: 20px"> 
<h2 align="center"> –†—É–±—Ä–∏–∫–∞ ¬´–ü–∏—Ç–æ–Ω—è—á–∏–π –ª–∞–π—Ñ—Ö–∞–∫–µ—Ä¬ª <a class="tocSkip"> </h2>

<h3> –ú–æ–¥—É–ª—å itertools <a class="tocSkip"> </h3>

–≠—Ç–æ—Ç –º–æ–¥—É–ª—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∏—Ä—É–µ—Ç –æ—Å–Ω–æ–≤–Ω–æ–π –Ω–∞–±–æ—Ä –±—ã—Å—Ç—Ä—ã—Ö, —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ –ø–∞–º—è—Ç–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–ª–µ–∑–Ω—ã —Å–∞–º–∏ –ø–æ —Å–µ–±–µ –∏–ª–∏ –≤ —Å–æ—á–µ—Ç–∞–Ω–∏–∏. –í–º–µ—Å—Ç–µ –æ–Ω–∏ –æ–±—Ä–∞–∑—É—é—Ç `iterator algebra` –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Å–æ–∑–¥–∞–≤–∞—Ç—å –ª–∞–∫–æ–Ω–∏—á–Ω—ã–µ –∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–µ —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –Ω–∞ —á–∏—Å—Ç–æ–º Python. –ü—Ä–µ–ª–µ—Å—Ç—å –∑–∞–∫–ª—é—á–∞–µ—Ç—Å—è –≤ —Ç–æ–º, —á—Ç–æ –º–æ–¥—É–ª—å `itertools` –¥–æ—Å—Ç—É–ø–µ–Ω –≤ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–π –±–∏–±–ª–∏–æ—Ç–µ–∫–µ Python.

–ù–∏–∂–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø—Ä–∏–º–µ—Ä–æ–≤, –∫–æ—Ç–æ–ª—Ä—ã–º–∏ —á–∞—Å—Ç–æ –ø–æ–ª—å–∑—É—é—Å—å —è

```python
import itertools
print(list(itertools.product("ABC", [1, 2])))
print(list(itertools.permutations([3, "Python"], 2)))
```

–ß—Ç–æ–±—ã –±–æ–ª–µ–µ –¥–µ–ª–∞–ª—å–Ω–µ–µ –∏–∑—É—á–∏—Ç—å –º–æ–¥—É–ª—å —Ç—ã –º–æ–∂–µ—à—å –ø–æ—á–∏—Ç–∞—Ç—å

1. [–°—Ç–∞—Ç—å—è –Ω–∞ habr "Itertools –≤ Python"](https://habr.com/ru/company/otus/blog/529356/)
2. [–ú–æ–¥—É–ª—å Itertools –≤ Python –Ω–∞ –ø—Ä–∏–º–µ—Ä–∞—Ö](https://pythonpip.ru/osnovy/itertools)

def load_train(path):
    labels = pd.read_csv(path + 'labels.csv')
    
    train_datagen = ImageDataGenerator(validation_split=0.25, rescale=1./255, horizontal_flip=True)
    
    train_gen_flow = train_datagen.flow_from_dataframe(
        dataframe=labels,
        directory=path + 'final_files/',
        x_col='file_name',
        y_col='real_age',
        target_size=(224, 224),
        batch_size=16,
        class_mode='raw',
        subset='training',
        seed=12345)

    return train_gen_flow
    
         

def load_test(path):
    labels = pd.read_csv(path + 'labels.csv')
                                                           
    test_datagen = ImageDataGenerator(validation_split=0.25, rescale=1/255)
                                                           
    test_gen_flow = test_datagen.flow_from_dataframe(
        dataframe=labels,
        directory=path + 'final_files/',
        x_col='file_name',
        y_col='real_age',
        target_size=(224, 224),
        batch_size=16,
        class_mode='raw',
        subset='validation',
        seed=12345)

    return test_gen_flow


def create_model(input_shape):
    backbone = ResNet50(input_shape=input_shape,
                    weights='imagenet', 
                    include_top=False)
        
    model = Sequential()
    model.add(backbone)
    model.add(GlobalAveragePooling2D())
    model.add(Dense(1, activation='relu'))
    optimizer = Adam(lr=0.0001)
    model.compile(loss='mean_squared_error', metrics=['mae'], optimizer=optimizer)

    return model


def train_model(model, train_data, test_data, batch_size=None, epochs=15,
                steps_per_epoch=None, validation_steps=None):

    model.fit(train_data,
              validation_data=test_data,
              batch_size=batch_size, 
              epochs=epochs,
              steps_per_epoch=steps_per_epoch,
              validation_steps=validation_steps,
              verbose=2)

    return model


    




```

# < —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤—ã–≤–æ–¥–∞ –Ω–∞ —ç–∫—Ä–∞–Ω —Å—é–¥–∞ >
# < –¥–ª–∏–Ω–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏ —Å–æ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ–º –º–æ–¥–µ–ª–∏ –º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å >

```



```
 Train for 356 steps, validate for 119 steps
Epoch 1/15
2023-09-03 06:01:10.914718: I tensorflow/stream_executor/platform/default/dso_loader.cc:44] Successfully opened dynamic library libcublas.so.10
2023-09-03 06:01:11.324467: I tensorflow/stream_executor/platform/default/dso_loader.cc:44] Successfully opened dynamic library libcudnn.so.7
356/356 - 70s - loss: 201.2985 - mae: 10.2514 - val_loss: 649.7597 - val_mae: 20.3409
Epoch 2/15
356/356 - 53s - loss: 82.5849 - mae: 6.9346 - val_loss: 140.6518 - val_mae: 8.8843
Epoch 3/15
356/356 - 57s - loss: 57.8470 - mae: 5.8211 - val_loss: 80.1819 - val_mae: 6.6875
Epoch 4/15
356/356 - 48s - loss: 40.9841 - mae: 4.9538 - val_loss: 96.3579 - val_mae: 7.6437
Epoch 5/15
356/356 - 49s - loss: 32.5094 - mae: 4.3420 - val_loss: 68.5298 - val_mae: 6.1538
Epoch 6/15
356/356 - 57s - loss: 27.4685 - mae: 3.9902 - val_loss: 74.4213 - val_mae: 6.4524
Epoch 7/15
356/356 - 53s - loss: 22.3478 - mae: 3.5784 - val_loss: 67.2534 - val_mae: 6.1833
Epoch 8/15
356/356 - 44s - loss: 17.3483 - mae: 3.1508 - val_loss: 66.3183 - val_mae: 6.2294
Epoch 9/15
356/356 - 57s - loss: 14.0614 - mae: 2.8367 - val_loss: 63.4768 - val_mae: 5.8864
Epoch 10/15
356/356 - 57s - loss: 13.0804 - mae: 2.7540 - val_loss: 81.9567 - val_mae: 6.9749
Epoch 11/15
356/356 - 41s - loss: 12.3619 - mae: 2.6781 - val_loss: 87.4584 - val_mae: 7.1715
Epoch 12/15
356/356 - 41s - loss: 12.2255 - mae: 2.6575 - val_loss: 65.4839 - val_mae: 6.1685
Epoch 13/15
356/356 - 38s - loss: 12.0873 - mae: 2.6562 - val_loss: 62.3622 - val_mae: 5.8841
Epoch 14/15
356/356 - 38s - loss: 11.1680 - mae: 2.5404 - val_loss: 66.5377 - val_mae: 5.9507
Epoch 15/15
356/356 - 40s - loss: 10.8475 - mae: 2.4999 - val_loss: 63.6275 - val_mae: 5.9041
WARNING:tensorflow:sample_weight modes were coerced from
  ...
    to  
  ['...']
119/119 - 10s - loss: 63.6275 - mae: 5.9041   
–õ–æ–≥–∏
```    



## –ê–Ω–∞–ª–∏–∑ –æ–±—É—á–µ–Ω–Ω–æ–π –º–æ–¥–µ–ª–∏

–í—ã–≤–æ–¥: –ò—Ç–∞–∫, –≤ –Ω–∞—à–µ–º —Ä–∞—Å–ø–æ—Ä—è–∂–µ–Ω–∏–∏ –µ—Å—Ç—å –¥–∞—Ç–∞—Å–µ—Ç —Å 7591 —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–µ–π, –∏ –º—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ —Å–≤–µ—Ä—Ç–æ—á–Ω—É—é –Ω–µ–π—Ä–æ—Å–µ—Ç—å –Ω–∞ –æ—Å–Ω–æ–≤–µ ResNet50. –í —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∏—Ç—å—Å—è –ø–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–π —Ü–µ–ª–∏, –∞ –∏–º–µ–Ω–Ω–æ: MAE = 5.9, —á—Ç–æ –Ω–µ –±–æ–ª—å—à–µ —Ç—Ä–µ–±—É–µ–º—ã—Ö 8. –¢–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º, –ø–æ–≥—Ä–µ—à–Ω–æ—Å—Ç—å —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç 6 –ª–µ—Ç. –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ, –º–æ–¥–µ–ª—å –ø—Ä–∏–≥–æ–¥–Ω–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –∑–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞—Ç—å –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–π –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–π –≤–æ–∑—Ä–∞—Å—Ç–Ω–æ–π –≥—Ä—É–ø–ø—ã. –ù–æ –≤—Ä—è–¥ –ª–∏ –º–æ–∂–Ω–æ –≥–æ–≤–æ—Ä–∏—Ç—å –æ —Ç–æ–º, —á—Ç–æ –º–æ–¥–µ–ª—å –ø–æ–¥–æ–π–¥–µ—Ç –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è –¥–æ–±—Ä–æ—Å–æ–≤–µ—Å—Ç–Ω–æ—Å—Ç–∏ –∫–∞—Å—Å–∏—Ä–æ–≤ –ø—Ä–∏ –ø—Ä–æ–¥–∞–∂–µ –∞–ª–∫–æ–≥–æ–ª—è.


