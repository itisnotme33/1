–ü—Ä–∏–≤–µ—Ç!  –º–µ–Ω—è –∑–æ–≤—É—Ç –õ—é–º–∞–Ω –ê–±–ª–∞–µ–≤. –°–µ–≥–æ–¥–Ω—è —è –ø—Ä–æ–≤–µ—Ä—é —Ç–≤–æ–π –ø—Ä–æ–µ–∫—Ç.
<br> –î–∞–ª—å–Ω–µ–π—à–µ–µ –æ–±—â–µ–Ω–∏–µ –±—É–¥–µ—Ç –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç—å –Ω–∞ "—Ç—ã" –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç –Ω–∏–∫–∞–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º.
<br> –ñ–µ–ª–∞—Ç–µ–ª—å–Ω–æ —Ä–µ–∞–≥–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ –∫–∞–∂–¥—ã–π –º–æ–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π ('–∏—Å–ø—Ä–∞–≤–∏–ª', '–Ω–µ –ø–æ–Ω—è—Ç–Ω–æ –∫–∞–∫ –∏—Å–ø—Ä–∞–≤–∏—Ç—å –æ—à–∏–±–∫—É', ...)
<br> –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–µ —É–¥–∞–ª—è–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ —Ä–µ–≤—å—é–µ—Ä–∞, —Ç–∞–∫ –∫–∞–∫ –æ–Ω–∏ –ø–æ–≤—ã—à–∞—é—Ç –∫–∞—á–µ—Å—Ç–≤–æ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ —Ä–µ–≤—å—é.

–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –±—É–¥—É—Ç –≤ <font color='green'>–∑–µ–ª–µ–Ω–æ–π</font>, <font color='blue'>—Å–∏–Ω–µ–π</font> –∏–ª–∏ <font color='red'>–∫—Ä–∞—Å–Ω–æ–π</font> —Ä–∞–º–∫–∞—Ö:

<div class="alert alert-block alert-success">
<b>–£—Å–ø–µ—Ö:</b> –ï—Å–ª–∏ –≤—Å–µ —Å–¥–µ–ª–∞–Ω–æ –æ—Ç–ª–∏—á–Ω–æ
</div>

<div class="alert alert-block alert-info">
<b>–°–æ–≤–µ—Ç: </b> –ï—Å–ª–∏ –º–æ–∂–Ω–æ –Ω–µ–º–Ω–æ–≥–æ —É–ª—É—á—à–∏—Ç—å
</div>

<div class="alert alert-block alert-danger">
<b>–û—à–∏–±–∫–∞:</b> –ï—Å–ª–∏ —Ç—Ä–µ–±—É—é—Ç—Å—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è. –†–∞–±–æ—Ç–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–∏–Ω—è—Ç–∞ —Å –∫—Ä–∞—Å–Ω—ã–º–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏.
</div>

-------------------

–ë—É–¥–µ—Ç –æ—á–µ–Ω—å —Ö–æ—Ä–æ—à–æ, –µ—Å–ª–∏ —Ç—ã –±—É–¥–µ—à—å –ø–æ–º–µ—á–∞—Ç—å —Å–≤–æ–∏ –¥–µ–π—Å—Ç–≤–∏—è —Å–ª–µ–¥—É—é—â–∏–º –æ–±—Ä–∞–∑–æ–º:
<div class="alert alert-block alert-warning">
<b>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Å—Ç—É–¥–µ–Ω—Ç–∞:</b> ...
</div>

<div class="alert alert-block alert-warning">
<b>–ò–∑–º–µ–Ω–µ–Ω–∏—è:</b> –ë—ã–ª–∏ –≤–Ω–µ—Å–µ–Ω—ã —Å–ª–µ–¥—É—é—â–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è ...
</div>

<font color='orange' style='font-size:24px; font-weight:bold'>–û–±—â–µ–µ –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏–µ</font>
* –ü—Ä–∏—è—Ç–Ω–æ –±—ã–ª–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å —Ç–≤–æ—é —Ä–∞–±–æ—Ç—É
- –Ø –æ—Å—Ç–∞–≤–∏–ª –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ —Å–æ–≤–µ—Ç—ã, –æ–±—Ä–∞—Ç–∏ –Ω–∞ –Ω–∏—Ö –≤–Ω–∏–º–∞–Ω–∏–µ. –ù–∞–¥–µ—é—Å—å –æ–Ω–∏ –±—É–¥—É—Ç –ø–æ–ª–µ–∑–Ω—ã–º–∏ –∏–ª–∏ –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–º–∏
- –ï—Å—Ç—å –º–∞–ª–µ–Ω—å–∫–∏–µ –≤ —Ä–∞–±–æ—Ç–µ, –Ω–æ —è –¥—É–º–∞—é —Ç—ã –±—ã—Å—Ç—Ä–æ –∏ –ª–µ–≥–∫–æ –∏—Ö –ø–æ–ø—Ä–∞–≤–∏—à—å
- –î–∞–≤–∞–π –µ—â–µ —Ä–∞–∑–æ–∫


	

<font color='orange' style='font-size:24px; font-weight:bold'>–û–±—â–µ–µ –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏–µ[2]</font>
* –°–ø–∞—Å–∏–±–æ –∑–∞ —É—Å–µ—Ä–¥–Ω–æ—Å—Ç—å!
- –ë—ã–ª–æ –ø—Ä–∏—è—Ç–Ω–æ —Å —Ç–æ–±–æ–π —Å–æ—Ç—Ä—É–¥–Ω–∏—á–∞—Ç—å.
- –ù–µ–¥–æ—á–µ—Ç—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã - —Ä–∞–±–æ—Ç–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞
- –ù–µ –±—É–¥—É –±–æ–ª—å—à–µ –∑–∞–¥–µ—Ä–∂–∏–≤–∞—Ç—å, –ø—Ä–æ–¥–æ–ª–∂–∞–π –≤ —Ç–æ–º –∂–µ –¥—É—Ö–µ.

<font color='green'><b>–ü–æ–ª–µ–∑–Ω—ã–µ (–∏ –ø—Ä–æ—Å—Ç–æ –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–µ) –º–∞—Ç–µ—Ä–∏–∞–ª—ã:</b> \
–î–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ç–µ–∫—Å—Ç–∞–º–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç –∏ –¥—Ä—É–≥–∏–µ –ø–æ–¥—Ö–æ–¥—ã. –ù–∞–ø—Ä–∏–º–µ—Ä, —Å–µ–π—á–∞—Å –∞–∫—Ç–∏–≤–Ω–æ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è RNN (LSTM) –∏ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–µ—Ä—ã (BERT –∏ –¥—Ä—É–≥–∏–µ —Å —É–ª–∏—Ü—ã –°–µ–∑–∞–º, –Ω–∞–ø—Ä–∏–º–µ—Ä, ELMO). –ù–û! –û–Ω–∏ –Ω–µ —è–≤–ª—è—é—Ç—Å—è –ø–∞–Ω–∞—Ü–µ–µ–π, –Ω–µ –≤—Å–µ–≥–¥–∞ –æ–Ω–∏ –Ω—É–∂–Ω—ã, —Ç–∞–∫ –∫–∞–∫ –∏ TF-IDF –∏–ª–∏ Word2Vec + –º–æ–¥–µ–ª–∏ –∏–∑ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–æ–≥–æ ML —Ç–æ–∂–µ –º–æ–≥—É—Ç —Å–ø—Ä–∞–≤–ª—è—Ç—å—Å—è. \
BERT —Ç—è–∂–µ–ª—ã–π, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –º–Ω–æ–≥–æ –µ–≥–æ –≤–∞—Ä–∏–∞—Ü–∏–π –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –∑–∞–¥–∞—á, –µ—Å—Ç—å –≥–æ—Ç–æ–≤—ã–µ –º–æ–¥–µ–ª–∏, –µ—Å—Ç—å –Ω–∞–¥—Å—Ç—Ä–æ–π–∫–∏ –Ω–∞–¥ –±–∏–±–ª–∏–æ—Ç–µ–∫–æ–π transformers. –ï—Å–ª–∏, –æ–±—É—á–∞—Ç—å BERT –Ω–∞ GPU (–º–æ–∂–Ω–æ –≤ Google Colab –∏–ª–∏ Kaggle), —Ç–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø–æ–±—ã—Å—Ç—Ä–µ–µ.\
https://huggingface.co/transformers/model_doc/bert.html \
https://t.me/renat_alimbekov \
https://colah.github.io/posts/2015-08-Understanding-LSTMs/ - –ü—Ä–æ LSTM \
https://web.stanford.edu/~jurafsky/slp3/10.pdf - –ø—Ä–æ —ç–Ω–∫–æ–¥–µ—Ä-–¥–µ–∫–æ–¥–µ—Ä –º–æ–¥–µ–ª–∏, —ç—Ç–µ–Ω—à–µ–Ω—ã\
https://pytorch.org/tutorials/beginner/transformer_tutorial.html - –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π –≥–∞–π–¥
–ø–æ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–µ—Ä—É –æ—Ç —Å–æ–∑–¥–∞—Ç–µ–ª–µ–π pytorch\
https://transformer.huggingface.co/ - –ø–æ–±–æ–ª—Ç–∞—Ç—å —Å —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–µ—Ä–æ–º \
–ë–∏–±–ª–∏–æ—Ç–µ–∫–∏: allennlp, fairseq, transformers, tensorflow-text ‚Äî –º–Ω–æ–∂–µ—Å—Ç–≤–æ—Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö
–º–µ—Ç–æ–¥–æ–≤ –¥–ª—è —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–µ—Ä–æ–≤ –º–µ—Ç–æ–¥–æ–≤ NLP \
Word2Vec https://radimrehurek.com/gensim/models/word2vec.html 

<font color='green'>–ü—Ä–∏–º–µ—Ä BERT —Å GPU:
```python
%%time
from tqdm import notebook
batch_size = 2 # –¥–ª—è –ø—Ä–∏–º–µ—Ä–∞ –≤–æ–∑—å–º–µ–º —Ç–∞–∫–æ–π –±–∞—Ç—á, –≥–¥–µ –±—É–¥–µ—Ç –≤—Å–µ–≥–æ –¥–≤–µ —Å—Ç—Ä–æ–∫–∏ –¥–∞—Ç–∞—Å–µ—Ç–∞
embeddings = [] 
for i in notebook.tqdm(range(input_ids.shape[0] // batch_size)):
        batch = torch.LongTensor(input_ids[batch_size*i:batch_size*(i+1)]).cuda() # –∑–∞–∫–∏–¥—ã–≤–∞–µ–º —Ç–µ–Ω–∑–æ—Ä –Ω–∞ GPU
        attention_mask_batch = torch.LongTensor(attention_mask[batch_size*i:batch_size*(i+1)]).cuda()
        
        with torch.no_grad():
            model.cuda()
            batch_embeddings = model(batch, attention_mask=attention_mask_batch)
        
        embeddings.append(batch_embeddings[0][:,0,:].cpu().numpy()) # –ø–µ—Ä–µ–≤–æ–¥ –æ–±—Ä–∞—Ç–Ω–æ –Ω–∞ –ø—Ä–æ—Ü, —á—Ç–æ–±—ã –≤ –Ω—É–º–ø–∞–π –∫–∏–Ω—É—Ç—å
        del batch
        del attention_mask_batch
        del batch_embeddings
        
features = np.concatenate(embeddings) 
```
–ú–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–∞ –Ω–∞–ª–∏—á–∏–µ GPU.\
–ù–∞–ø—Ä–∏–º–µ—Ä, —Ç–∞–∫: ```device = torch.device("cuda:0") if torch.cuda.is_available() else torch.device("cpu")```\
–¢–æ–≥–¥–∞ –≤–º–µ—Å—Ç–æ .cuda() –Ω—É–∂–Ω–æ –ø–∏—Å–∞—Ç—å .to(device)


<h1>–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ<span class="tocSkip"></span></h1>
<div class="toc"><ul class="toc-item"><li><span><a href="#–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞" data-toc-modified-id="–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞-1"><span class="toc-item-num">1&nbsp;&nbsp;</span>–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞</a></span></li><li><span><a href="#–û–±—É—á–µ–Ω–∏–µ" data-toc-modified-id="–û–±—É—á–µ–Ω–∏–µ-2"><span class="toc-item-num">2&nbsp;&nbsp;</span>–û–±—É—á–µ–Ω–∏–µ</a></span></li><li><span><a href="#–í—ã–≤–æ–¥—ã" data-toc-modified-id="–í—ã–≤–æ–¥—ã-3"><span class="toc-item-num">3&nbsp;&nbsp;</span>–í—ã–≤–æ–¥—ã</a></span></li><li><span><a href="#–ß–µ–∫-–ª–∏—Å—Ç-–ø—Ä–æ–≤–µ—Ä–∫–∏" data-toc-modified-id="–ß–µ–∫-–ª–∏—Å—Ç-–ø—Ä–æ–≤–µ—Ä–∫–∏-4"><span class="toc-item-num">4&nbsp;&nbsp;</span>–ß–µ–∫-–ª–∏—Å—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏</a></span></li></ul></div>

# –ü—Ä–æ–µ–∫—Ç –¥–ª—è ¬´–í–∏–∫–∏—à–æ–ø¬ª

–ò–Ω—Ç–µ—Ä–Ω–µ—Ç-–º–∞–≥–∞–∑–∏–Ω ¬´–í–∏–∫–∏—à–æ–ø¬ª –∑–∞–ø—É—Å–∫–∞–µ—Ç –Ω–æ–≤—ã–π —Å–µ—Ä–≤–∏—Å. –¢–µ–ø–µ—Ä—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∏ –¥–æ–ø–æ–ª–Ω—è—Ç—å –æ–ø–∏—Å–∞–Ω–∏—è —Ç–æ–≤–∞—Ä–æ–≤, –∫–∞–∫ –≤ –≤–∏–∫–∏-—Å–æ–æ–±—â–µ—Å—Ç–≤–∞—Ö. –¢–æ –µ—Å—Ç—å –∫–ª–∏–µ–Ω—Ç—ã –ø—Ä–µ–¥–ª–∞–≥–∞—é—Ç —Å–≤–æ–∏ –ø—Ä–∞–≤–∫–∏ –∏ –∫–æ–º–º–µ–Ω—Ç–∏—Ä—É—é—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥—Ä—É–≥–∏—Ö. –ú–∞–≥–∞–∑–∏–Ω—É –Ω—É–∂–µ–Ω –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –∏—Å–∫–∞—Ç—å —Ç–æ–∫—Å–∏—á–Ω—ã–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∏ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –∏—Ö –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏—é. 

–û–±—É—á–∏—Ç–µ –º–æ–¥–µ–ª—å –∫–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –Ω–∞ –ø–æ–∑–∏—Ç–∏–≤–Ω—ã–µ –∏ –Ω–µ–≥–∞—Ç–∏–≤–Ω—ã–µ. –í –≤–∞—à–µ–º —Ä–∞—Å–ø–æ—Ä—è–∂–µ–Ω–∏–∏ –Ω–∞–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö —Å —Ä–∞–∑–º–µ—Ç–∫–æ–π –æ —Ç–æ–∫—Å–∏—á–Ω–æ—Å—Ç–∏ –ø—Ä–∞–≤–æ–∫.

–ü–æ—Å—Ç—Ä–æ–π—Ç–µ –º–æ–¥–µ–ª—å —Å–æ –∑–Ω–∞—á–µ–Ω–∏–µ–º –º–µ—Ç—Ä–∏–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞ *F1* –Ω–µ –º–µ–Ω—å—à–µ 0.75. 

**–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—é –ø—Ä–æ–µ–∫—Ç–∞**

1. –ó–∞–≥—Ä—É–∑–∏—Ç–µ –∏ –ø–æ–¥–≥–æ—Ç–æ–≤—å—Ç–µ –¥–∞–Ω–Ω—ã–µ.
2. –û–±—É—á–∏—Ç–µ —Ä–∞–∑–Ω—ã–µ –º–æ–¥–µ–ª–∏. 
3. –°–¥–µ–ª–∞–π—Ç–µ –≤—ã–≤–æ–¥—ã.

–î–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞ –ø—Ä–∏–º–µ–Ω—è—Ç—å *BERT* –Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ, –Ω–æ –≤—ã –º–æ–∂–µ—Ç–µ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å.

**–û–ø–∏—Å–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö**

–î–∞–Ω–Ω—ã–µ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ —Ñ–∞–π–ª–µ `toxic_comments.csv`. –°—Ç–æ–ª–±–µ—Ü *text* –≤ –Ω—ë–º —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–µ–∫—Å—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è, –∞ *toxic* ‚Äî —Ü–µ–ª–µ–≤–æ–π –ø—Ä–∏–∑–Ω–∞–∫.

## –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞


```python
pip install --upgrade pandas
```

    Requirement already satisfied: pandas in /opt/conda/lib/python3.9/site-packages (2.0.3)
    Requirement already satisfied: pytz>=2020.1 in /opt/conda/lib/python3.9/site-packages (from pandas) (2021.1)
    Requirement already satisfied: numpy>=1.20.3 in /opt/conda/lib/python3.9/site-packages (from pandas) (1.21.1)
    Requirement already satisfied: python-dateutil>=2.8.2 in /opt/conda/lib/python3.9/site-packages (from pandas) (2.8.2)
    Requirement already satisfied: tzdata>=2022.1 in /opt/conda/lib/python3.9/site-packages (from pandas) (2023.3)
    Requirement already satisfied: six>=1.5 in /opt/conda/lib/python3.9/site-packages (from python-dateutil>=2.8.2->pandas) (1.16.0)
    Note: you may need to restart the kernel to use updated packages.



```python
import numpy as np
import pandas as pd
import re
import nltk
from nltk import pos_tag
from nltk.stem import WordNetLemmatizer
from nltk.corpus import stopwords as nltk_stopwords
from sklearn.feature_extraction.text import TfidfVectorizer
from sklearn.model_selection import train_test_split, cross_val_score
from sklearn.linear_model import LogisticRegression
from sklearn.tree import DecisionTreeClassifier
from sklearn.ensemble import RandomForestClassifier
from sklearn.metrics import f1_score, roc_auc_score, roc_curve
from sklearn.model_selection import cross_val_predict
from sklearn.utils import shuffle
import matplotlib.pyplot as plt
from tqdm import tqdm
```


<div class="alert alert-block alert-success">
<b>–£—Å–ø–µ—Ö:</b> –ò–º–ø–æ—Ä—Ç—ã –Ω–∞ –º–µ—Å—Ç–µ
</div>



```python
data = pd.read_csv('/datasets/toxic_comments.csv')
data.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Unnamed: 0</th>
      <th>text</th>
      <th>toxic</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>Explanation\nWhy the edits made under my usern...</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>D'aww! He matches this background colour I'm s...</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2</td>
      <td>Hey man, I'm really not trying to edit war. It...</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>3</td>
      <td>"\nMore\nI can't make any real suggestions on ...</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>4</td>
      <td>You, sir, are my hero. Any chance you remember...</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div>




```python
data.info()
```

    <class 'pandas.core.frame.DataFrame'>
    RangeIndex: 159292 entries, 0 to 159291
    Data columns (total 3 columns):
     #   Column      Non-Null Count   Dtype 
    ---  ------      --------------   ----- 
     0   Unnamed: 0  159292 non-null  int64 
     1   text        159292 non-null  object
     2   toxic       159292 non-null  int64 
    dtypes: int64(2), object(1)
    memory usage: 3.6+ MB



```python
data.describe()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Unnamed: 0</th>
      <th>toxic</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>159292.000000</td>
      <td>159292.000000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>79725.697242</td>
      <td>0.101612</td>
    </tr>
    <tr>
      <th>std</th>
      <td>46028.837471</td>
      <td>0.302139</td>
    </tr>
    <tr>
      <th>min</th>
      <td>0.000000</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>39872.750000</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>79721.500000</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>119573.250000</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>max</th>
      <td>159450.000000</td>
      <td>1.000000</td>
    </tr>
  </tbody>
</table>
</div>




```python
data.isna().sum()
```




    Unnamed: 0    0
    text          0
    toxic         0
    dtype: int64




```python
data.duplicated().sum()
```




    0




```python
data['toxic'].value_counts()
```




    toxic
    0    143106
    1     16186
    Name: count, dtype: int64



–í–∏–¥–∏–º, —á—Ç–æ –Ω–∞–±–ª—é–¥–∞–µ—Ç—Å—è –¥–∏—Å–±–∞–ª–∞–Ω—Å –∫–ª–∞—Å—Å–æ–≤

<div class="alert alert-block alert-success">
<b>–£—Å–ø–µ—Ö:</b> –û—Ç–ª–∏—á–Ω–æ, —á—Ç–æ –æ–±–Ω–∞—Ä—É–∂–µ–Ω –¥–∏—Å–±–∞–ª–∞–Ω—Å - —ç—Ç–æ –æ—á–µ–Ω—å –≤–∞–∂–Ω–æ –≤ –∑–∞–¥–∞—á–∞—Ö –∫–∞–ª—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏
</div>

–õ–µ–º–º–∞—Ç–∏–∑–∞—Ü–∏—è


```python
lemmatizer = WordNetLemmatizer()

def lemmatize_text(text):
    lemm_text = "".join(lemmatizer.lemmatize(text))
    cleared_text = re.sub(r'[^a-zA-Z]', ' ', lemm_text) 
    return " ".join(cleared_text.split())

data['lemm_text'] = data['text'].apply(lemmatize_text)
data = data.drop(['text'], axis=1)
```


```python
def get_wordnet_pos(word):
    tag = nltk.pos_tag([word])[0][1][0].upper()
    tag_dict = {"J": wordnet.ADJ,
                "N": wordnet.NOUN,
                "V": wordnet.VERB,
                "R": wordnet.ADV}
    return tag_dict.get(tag, wordnet.NOUN)
```


<div class="alert alert-block alert-danger">
    
<b>–û—à–∏–±–∫–∞:</b>  –î–ª—è –±–æ–ª–µ–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã  WordNetLemmatizer, –≤–º–µ—Å—Ç–æ —Å–æ —Å–ª–æ–≤–æ–º, –∂–µ–ª–∞—Ç–µ–ª—å–Ω–æ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å –µ–≥–æ POS-—Ç–µ–≥ (part of speech). https://webdevblog.ru/podhody-lemmatizacii-s-primerami-v-python/
    
</div>



<div class="alert alert-block alert-warning">
<b>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Å—Ç—É–¥–µ–Ω—Ç–∞: –ü—Ä–∏–º–µ–Ω–∏–ª POS-—Ç–µ–≥</b>
</div>

<div class="alert alert-block alert-success">
    
<b>–£—Å–ø–µ—Ö[2]:</b> üëç
</div>



```python
data.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Unnamed: 0</th>
      <th>toxic</th>
      <th>lemm_text</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>0</td>
      <td>Explanation Why the edits made under my userna...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>0</td>
      <td>D aww He matches this background colour I m se...</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2</td>
      <td>0</td>
      <td>Hey man I m really not trying to edit war It s...</td>
    </tr>
    <tr>
      <th>3</th>
      <td>3</td>
      <td>0</td>
      <td>More I can t make any real suggestions on impr...</td>
    </tr>
    <tr>
      <th>4</th>
      <td>4</td>
      <td>0</td>
      <td>You sir are my hero Any chance you remember wh...</td>
    </tr>
  </tbody>
</table>
</div>




<div class="alert alert-block alert-info">
    
<b>–°–æ–≤–µ—Ç:</b>  –ù–µ–ø–ª–æ—Ö–æ –±—ã–ª–æ –±—ã –¥–ª—è –Ω–∞–≥–ª—è–¥–Ω–æ—Å—Ç–∏ –∏ —Å–∞–º–æ–ø—Ä–æ–≤–µ—Ä–∫–∏ –≤—ã–≤–µ—Å—Ç–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–æ/–ø–æ—Å–ª–µ.
</div>


<div class="alert alert-block alert-warning">
<b>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Å—Ç—É–¥–µ–Ω—Ç–∞: –í—ã–≤–µ–ª –Ω–∏–∂–µ</b> 
</div>

<div class="alert alert-block alert-success">
    
<b>–£—Å–ø–µ—Ö[2]:</b> –ï—Å—Ç—å
</div>



```python
data.info()
```

    <class 'pandas.core.frame.DataFrame'>
    RangeIndex: 159292 entries, 0 to 159291
    Data columns (total 3 columns):
     #   Column      Non-Null Count   Dtype 
    ---  ------      --------------   ----- 
     0   Unnamed: 0  159292 non-null  int64 
     1   toxic       159292 non-null  int64 
     2   lemm_text   159292 non-null  object
    dtypes: int64(2), object(1)
    memory usage: 3.6+ MB



```python
data.describe()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Unnamed: 0</th>
      <th>toxic</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>159292.000000</td>
      <td>159292.000000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>79725.697242</td>
      <td>0.101612</td>
    </tr>
    <tr>
      <th>std</th>
      <td>46028.837471</td>
      <td>0.302139</td>
    </tr>
    <tr>
      <th>min</th>
      <td>0.000000</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>39872.750000</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>79721.500000</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>119573.250000</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>max</th>
      <td>159450.000000</td>
      <td>1.000000</td>
    </tr>
  </tbody>
</table>
</div>




```python
data.isna().sum()
```




    Unnamed: 0    0
    toxic         0
    lemm_text     0
    dtype: int64




```python
data.duplicated().sum()
```




    0




```python
data['toxic'].value_counts()
```




    toxic
    0    143106
    1     16186
    Name: count, dtype: int64



## –û–±—É—á–µ–Ω–∏–µ

–í–æ–∑—å–º–µ–º —Ç—Ä–∏ –º–æ–¥–µ–ª–∏: LogisticRegression, RandomForestClassifier –∏ DecisionTreeClassifier


```python
features = data.drop(['toxic'], axis=1)
target = data['toxic']

features_train, features_test, target_train, target_test = train_test_split(
    features, target, test_size=0.3, random_state=12345)

features_valid, features_test, target_valid, target_test = train_test_split(
    features_test, target_test, test_size=0.5, random_state=12345)
```


```python
nltk.download('stopwords')
stopwords = set(nltk_stopwords.words('english'))

count_tf_idf = TfidfVectorizer(stop_words=stopwords)

features_train = count_tf_idf.fit_transform(features_train['lemm_text'])   
features_test = count_tf_idf.transform(features_test['lemm_text'])
features_valid = count_tf_idf.transform(features_valid['lemm_text'])

cv_counts = 2
```

    [nltk_data] Downloading package stopwords to /home/jovyan/nltk_data...
    [nltk_data]   Package stopwords is already up-to-date!


<div class="alert alert-block alert-success">

<b>–£—Å–ø–µ—Ö:</b> –•–æ—Ä–æ—à–æ, —á—Ç–æ –≤–µ–∫—Ç–æ—Ä–∏–∑–∞—Ç–æ—Ä –æ–±—É—á–µ–Ω —Ç–æ–ª—å–∫–æ –Ω–∞ –æ–±—É—á–∞—é—â–µ–π –≤—ã–±–æ—Ä–∫–µ - —ç—Ç–æ —É–º–µ–Ω—å—à–∞–µ—Ç –ø–µ—Ä–µ–æ–±—É—á–µ–Ω–∏–µ 
</div>




<div class="alert alert-block alert-danger">
<b>–û—à–∏–±–∫–∞:</b>  –ü—Ä–∏–≤–æ–¥–∏—Ç—å –∞–Ω–≥–ª–∏–π—Å–∫–∏–µ —Ç–µ–∫—Å—Ç—ã –∫ —é–Ω–∏–∫–æ–¥—É –Ω–µ –∏–º–µ–µ—Ç —Å–º—ã—Å–ª–∞, —Ç–∞–∫ –∫–∞–∫ —ç—Ç–æ –ø—Ä–∏–≤–æ–¥–∏—Ç —Ç–æ–ª—å–∫–æ –∫ —É–≤–µ–ª–∏—á–µ–Ω–∏—é –∑–∞–Ω–∏–º–∞–µ–º–æ–π –ø–∞–º—è—Ç–∏. 
</div>


<div class="alert alert-block alert-warning">
<b>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Å—Ç—É–¥–µ–Ω—Ç–∞: –£–±—Ä–∞–ª –ø—Ä–∏–≤–µ–¥–µ–Ω–∏–µ –∫ —é–Ω–∏–∫–æ–¥—É</b> 
</div>

<div class="alert alert-block alert-success">
    
<b>–£—Å–ø–µ—Ö[2]:</b> üëç
</div>



```python
print(features_train.shape)
print(target_train.shape)
```

    (111504, 136390)
    (111504,)



```python
print(features_test.shape)
print(target_test.shape)
```

    (23894, 136390)
    (23894,)



```python
print(features_valid.shape)
print(target_valid.shape)
```

    (23894, 136390)
    (23894,)


–ö—Ä–æ—Å—Å–≤–∞–ª–∏–¥–∞—Ü–∏—è


```python
%%time

model_lr = LogisticRegression(random_state=12345, solver='liblinear')
train_f1 = cross_val_score(model_lr, 
                      features_train, 
                      target_train, 
                      cv=cv_counts, 
                      scoring='f1').mean()
print('f1 –Ω–∞ CV', train_f1)
```

    f1 –Ω–∞ CV 0.6606483045999401
    CPU times: user 3.88 s, sys: 6.91 s, total: 10.8 s
    Wall time: 10.8 s



<div class="alert alert-block alert-info">
<b>–°–æ–≤–µ—Ç: </b>  –¢–∞–∫–∂–µ –Ω–∞–ø–æ–º–Ω—é, —á—Ç–æ –≤–Ω—É—Ç—Ä–∏ –∫—Ä–æ—Å—Å-–≤–∞–ª–∏–¥–∞—Ü–∏–∏ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ö —Ä–∞–∑–±–∏–µ–Ω–∏–µ –≤—ã–±–æ—Ä–∫–∏ –Ω–∞ —Ç—Ä–µ–∏–Ω –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—é. –û–¥–Ω–∞–∫–æ, –≤ —Ç–∞–∫–æ–º —Å–ª—É—á–∞–µ –≤–µ–∫—Ç–æ—Ä–∏–∑–∞—Ç–æ—Ä –æ–±—É—á–µ–Ω –Ω–∞ –≤—Å–µ–π –≤—ã–±–æ—Ä–∫–µ, –∞ —ç—Ç–æ –Ω–µ —Å–æ–≤—Å–µ–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ. –î–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è —Ç–∞–∫–æ–≥–æ —ç—Ñ—Ñ–µ–∫—Ç–∞ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å <a href="https://scikit-learn.org/stable/modules/generated/sklearn.pipeline.Pipeline.html">–ø–∞–π–ø–ª–∞–π–Ω</a>.
</div>



```python
%%time

model_rf = RandomForestClassifier(random_state=12345)
train_f1 = cross_val_score(model_rf, 
                      features_train, 
                      target_train, 
                      cv=cv_counts, 
                      scoring='f1').mean()
print('f1 –Ω–∞ CV', train_f1)
```

    f1 –Ω–∞ CV 0.692156801576377
    CPU times: user 13min 59s, sys: 1.03 s, total: 14min
    Wall time: 14min 1s



```python
%%time

model_dt = DecisionTreeClassifier(random_state=12345)
train_f1 = cross_val_score(model_dt, 
                      features_train, 
                      target_train, 
                      cv=cv_counts, 
                      scoring='f1').mean()
print('f1 –Ω–∞ CV', train_f1)
```

    f1 –Ω–∞ CV 0.7046764095803355
    CPU times: user 4min 9s, sys: 96.6 ms, total: 4min 9s
    Wall time: 4min 9s


–í–∑–≤–µ—à–∏–≤–∞–Ω–∏–µ –∫–ª–∞—Å—Å–æ–≤


```python
%%time

model_lr_balanced = LogisticRegression(random_state=12345, class_weight='balanced')
train_f1_balanced = cross_val_score(model_lr_balanced, 
                                    features_train, 
                                    target_train, 
                                    cv=2, 
                                    scoring='f1').mean()
print('f1 –Ω–∞ CV –±–∞–ª–∞–Ω—Å', train_f1_balanced)
```

    f1 –Ω–∞ CV –±–∞–ª–∞–Ω—Å 0.7410237253567264
    CPU times: user 16 s, sys: 35.5 s, total: 51.5 s
    Wall time: 51.6 s



```python
%%time

model_rf_balanced = RandomForestClassifier(random_state=12345, class_weight='balanced')
train_f1_balanced = cross_val_score(model_rf_balanced, 
                                    features_train, 
                                    target_train, 
                                    cv=cv_counts, 
                                    scoring='f1').mean()
print('f1 –Ω–∞ CV –±–∞–ª–∞–Ω—Å', train_f1_balanced)
```

    f1 –Ω–∞ CV –±–∞–ª–∞–Ω—Å 0.6084766607589387
    CPU times: user 13min 7s, sys: 991 ms, total: 13min 7s
    Wall time: 13min 8s



```python
%%time

model_dt_balanced = DecisionTreeClassifier(random_state=12345, class_weight='balanced')
train_f1_balanced = cross_val_score(model_dt_balanced, 
                                    features_train, 
                                    target_train, 
                                    cv=cv_counts, 
                                    scoring='f1').mean()
print('f1 –Ω–∞ CV –±–∞–ª–∞–Ω—Å', train_f1_balanced)
```

    f1 –Ω–∞ CV –±–∞–ª–∞–Ω—Å 0.6159527553549822
    CPU times: user 1min 57s, sys: 136 ms, total: 1min 57s
    Wall time: 1min 57s


–î–∞—É–Ω—Å—ç–º–ø–ª–∏–Ω–≥


```python
data_train = data.iloc[target_train.index]
target_train_class_zero = data_train[data_train['toxic'] == 0]['toxic']
target_train_class_one = data_train[data_train['toxic'] == 1]['toxic']


target_train_class_zero_downsample = target_train_class_zero.sample(target_train_class_one.shape[0],
                                                                    random_state=12345)
target_train_downsample = pd.concat([target_train_class_zero_downsample, target_train_class_one])

features_train_downsample = data.iloc[target_train_downsample.index]


features_train_downsample, target_train_downsample = shuffle(features_train_downsample,
                                                             target_train_downsample,
                                                             random_state=12345)


features_train_downsample = count_tf_idf.transform(features_train_downsample['lemm_text'])


print('–î–æ–ª—è:')
print(target_train_downsample.value_counts(normalize=True))

print(features_train_downsample.shape)
print(target_train_downsample.shape)
```

    –î–æ–ª—è:
    toxic
    0    0.5
    1    0.5
    Name: proportion, dtype: float64
    (22596, 136390)
    (22596,)


<div class="alert alert-block alert-success">

<b>–£—Å–ø–µ—Ö:</b> downsample –ø—Ä–∏–º–µ–Ω–µ–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.
</div>




<div class="alert alert-block alert-danger">
<b>–û—à–∏–±–∫–∞:</b>  –¢–æ–∂–µ —Å–∞–º–æ–µ —Å –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–µ–π
</div>


<div class="alert alert-block alert-warning">
<b>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Å—Ç—É–¥–µ–Ω—Ç–∞: –ó–¥–µ—Å—å —Ç–æ–∂–µ —É–±—Ä–∞–ª —é–Ω–∏–∫–æ–¥</b> 
</div>

<div class="alert alert-block alert-success">
    
<b>–£—Å–ø–µ—Ö[2]:</b> üëç
</div>



```python
%%time

model_lr_downsample = LogisticRegression(random_state=12345, solver='liblinear')
model_lr_downsample.fit(features_train_downsample, target_train_downsample)
predictions_valid_lr_downsample = model_lr_downsample.predict(features_valid)

print("f1:", f1_score(target_valid, predictions_valid_lr_downsample))
```

    f1: 0.6964516129032258
    CPU times: user 1.65 s, sys: 3.92 s, total: 5.57 s
    Wall time: 5.54 s


<div class="alert alert-block alert-info">
    
<b>–°–æ–≤–µ—Ç:</b> –ù–µ–ø–ª–æ—Ö–æ –±—ã–ª–æ –±—ã –ø–æ–¥–æ–±—Ä–∞—Ç—å –≥–∏–ø–µ—Ä–ø–∞—Ä–∞–º–µ—Ç—Ä `C`
</div>



```python
%%time

best_model_rf = None
best_result_rf = 0
best_est_rf = 0
best_depth_rf = 0
for est in tqdm(range(1, 11)):
    for depth in range(1, 11):
        model_rf_downsample = RandomForestClassifier(random_state=12345, n_estimators=est, max_depth=depth)
        model_rf_downsample.fit(features_train_downsample, target_train_downsample)
        predictions_valid_rf_downsample = model_rf_downsample.predict(features_valid)
        result_rf = f1_score(predictions_valid_rf_downsample, target_valid)
        if result_rf > best_result_rf:
            best_model_rf = model_rf_downsample
            best_result_rf = result_rf
            best_est_rf = est
            best_depth_rf = depth
            
print(best_model_rf)
print('f1:', result_rf)
```

    100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 10/10 [00:17<00:00,  1.71s/it]

    RandomForestClassifier(max_depth=10, n_estimators=10, random_state=12345)
    f1: 0.276302101393994
    CPU times: user 16.9 s, sys: 54.6 ms, total: 16.9 s
    Wall time: 17.1 s


    




<div class="alert alert-block alert-danger">
<b>–û—à–∏–±–∫–∞:</b>  
    
1) –ó–¥–µ—Å—å –∫–æ–¥ –ø–∞–¥–∞–µ—Ç.  –ú–æ–¥–µ–ª—å –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π `model_rf`  —É —Ç–µ–±—è –Ω–µ –æ–±—É—á–µ–Ω–∞—è.
    
2) –ù–∞ —Ç–µ—Å—Ç–æ–≤–æ–π –≤—ã–±–æ—Ä–∫–µ –Ω–µ–ª—å–∑—è –ø–æ–¥–±–∏—Ä–∞—Ç—å –≥–∏–ø–µ—Ä–ø–∞—Ä–∞–º–µ—Ç—Ä—ã - –æ–Ω–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç –¥—Ä—É–≥—É—é —Ä–æ–ª—å.  –ú—ã –¥–ª—è —ç—Ç–æ–≥–æ –µ–µ –∏ –æ—Ç–∫–ª–∞–¥—ã–≤–∞–ª–∏, —á—Ç–æ–±—ã –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, –∫–∞–∫ —Ö–æ—Ä–æ—à–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è –º–æ–¥–µ–ª—å –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–∞ –¥–∞–Ω–Ω—ã—Ö, –ø–æ–¥ –∫–æ—Ç–æ—Ä—ã–µ –º—ã –µ–µ –Ω–µ –ø–æ–¥–≥–æ–Ω—è–ª–∏ - –∏—Å–ø—Ä–∞–≤—å —ç—Ç–æ –≤–µ–∑–¥–µ

</div>


<div class="alert alert-block alert-warning">
<b>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Å—Ç—É–¥–µ–Ω—Ç–∞: –í—Å–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ</b> 
</div>

<div class="alert alert-block alert-success">
    
<b>–£—Å–ø–µ—Ö[2]:</b> –ï—Å—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç
</div>



```python
%%time

best_model_dt = None
best_result_dt = 0
for depth in range(1, 11):
    model_dt_downsample = DecisionTreeClassifier(random_state=12345, max_depth=depth)
    model_dt_downsample.fit(features_train_downsample, target_train_downsample)
    predictions_valid_dt_downsample = model_dt_downsample.predict(features_valid)
    result_dt = f1_score(target_valid, predictions_valid_dt_downsample)
    if result_dt > best_result_dt:
        best_model_dt = model_dt_downsample
        best_depth_dt = depth
        best_result_dt = result_dt

print(best_model_dt) 
print('f1:', result_dt)
```

    DecisionTreeClassifier(max_depth=9, random_state=12345)
    f1: 0.559432933478735
    CPU times: user 13.3 s, sys: 4.06 ms, total: 13.3 s
    Wall time: 13.3 s




<div class="alert alert-block alert-danger">
<b>–û—à–∏–±–∫–∞:</b>  –ö—Ä–æ—Å—Å-–≤–∞–ª–∏–¥–∞—Ü–∏–æ–Ω–Ω—ã–µ –º–µ—Ç–æ–¥—ã –Ω–µ —Å–æ–≤–º–µ—Å—Ç–∏–º—ã —Å –º–µ—Ç–æ–¥–∞–º–∏ –¥–ª—è –±–æ—Ä—å–±—ã —Å –¥–∏—Å–±–∞–ª–∞–Ω—Å–æ–º upsample/downsample. –¢–∞–∫ –∫–∞–∫ –≤–Ω—É—Ç—Ä–∏ –∫—Ä–æ—Å—Å-–≤–∞–ª–∏–¥–∞—Ü–∏–∏ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Ä–∞–∑–±–∏–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Ç—Ä–µ–π–Ω/–≤–∞–ª–∏–¥. –ò —Ç–æ–≥–¥–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–æ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–∞—é—Ç—Å—è —Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ (—á—Ç–æ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç –Ω–∞—à–µ–π —Ç–µ–∫—É—â–µ–π –∑–∞–¥–∞—á–∏) - —ç—Ç–æ —Ç–µ–º —Å–∞–º—ã–º –≤–µ–¥–µ—Ç –∫ —Å–º–µ—â–µ–Ω–Ω—ã–º –æ—Ü–µ–Ω–∫–∞–º –∏–ª–∏ –≥–∏–ø–µ—Ä–ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º.

</div>


<div class="alert alert-block alert-warning">
<b>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Å—Ç—É–¥–µ–Ω—Ç–∞: –£–±—Ä–∞–ª –≤—Å–µ –ª–∏—à–Ω–µ–µ</b> 
</div>

<div class="alert alert-block alert-success">
    
<b>–£—Å–ø–µ—Ö[2]:</b> üëç
</div>


–ì—Ä–∞—Ñ–∏–∫ ROC-–∫—Ä–∏–≤–æ–π


```python
model_lr_balanced = LogisticRegression(random_state=12345)

predicted_probs = cross_val_predict(model_lr_balanced, features_train, target_train, cv=cv_counts, method='predict_proba')

fpr, tpr, thresholds = roc_curve(target_train, predicted_probs[:, 1])

auc_roc = roc_auc_score(target_train, predicted_probs[:, 1])

plt.plot(fpr, tpr, label='ROC curve (area = %0.2f)' % auc_roc)
plt.plot([0, 1], [0, 1], 'k--')
plt.xlim([0.0, 1.0])
plt.ylim([0.0, 1.05])
plt.xlabel('False Positive Rate')
plt.ylabel('True Positive Rate')
plt.title('Receiver Operating Characteristic')
plt.legend(loc="lower right")
plt.show()

print('auc_roc:', auc_roc)


f1_scores = cross_val_score(model_lr_balanced, 
                            features_train, 
                            target_train, 
                            cv=cv_counts, scoring='f1')
f1_mean = f1_scores.mean()
print('f1 –Ω–∞ CV:', f1_mean)


```


    
![png](output_68_0.png)
    


    auc_roc: 0.9641111491245011


–£–¥–∞–ª–æ—Å—å –¥–æ—Å—Ç–∏—á—å —Ç—Ä–µ–±—É–µ–º–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è f1, –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å auc_roc –±–ª–∏–∑–æ–∫ –∫ –µ–¥–∏–Ω–∏—Ü–µ, —ç—Ç–æ –≤—ã—à–µ —Å–ª—É—á–∞–π–Ω—ã—Ö 0.5



<div class="alert alert-block alert-danger">
<b>–û—à–∏–±–∫–∞:</b> –û—Ü–µ–Ω–∫–∞ f1 –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –Ω–∞ —Ç–µ—Å—Ç–µ > 0.75, –ê –æ—Ü–µ–Ω–∫–∞ –Ω–∞ –∫—Ä–æ—Å—Å-–≤–∞–ª–∏–¥–∞—Ü–∏–∏, –∏—Å–ø–æ–ª—å–∑—É—è downsampled –¥–∞–Ω–Ω—ã–µ - —Å–º–µ—â–µ–Ω–Ω–∞—è

</div>


<div class="alert alert-block alert-warning">
<b>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Å—Ç—É–¥–µ–Ω—Ç–∞: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ</b> 
</div>

<div class="alert alert-block alert-success">
    
<b>–£—Å–ø–µ—Ö[2]:</b> –ï—Å—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç
</div>


–ü–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–π –ª—É—á—à–∏–π –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å f1 —É –º–æ–¥–µ–ª–∏ LogisticRegression. –ù–∞ –Ω–µ–π –∏ –ø—Ä–æ–≤–µ–¥–µ–º —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ.


```python
model_best = LogisticRegression(random_state=12345, class_weight='balanced')

model_best.fit(features_train, target_train) 
predictions = model_best.predict(features_test)
result = f1_score(target_test, predictions)

print("f1 –ª—É—á—à–µ–π –º–æ–¥–µ–ª–∏ –Ω–∞ —Ç–µ—Å—Ç–æ–≤–æ–π –≤—ã–±–æ—Ä–∫–µ:", result)
```

    f1 –ª—É—á—à–µ–π –º–æ–¥–µ–ª–∏ –Ω–∞ —Ç–µ—Å—Ç–æ–≤–æ–π –≤—ã–±–æ—Ä–∫–µ: 0.750229399889888


    /opt/conda/lib/python3.9/site-packages/sklearn/linear_model/_logistic.py:763: ConvergenceWarning: lbfgs failed to converge (status=1):
    STOP: TOTAL NO. of ITERATIONS REACHED LIMIT.
    
    Increase the number of iterations (max_iter) or scale the data as shown in:
        https://scikit-learn.org/stable/modules/preprocessing.html
    Please also refer to the documentation for alternative solver options:
        https://scikit-learn.org/stable/modules/linear_model.html#logistic-regression
      n_iter_i = _check_optimize_result(


## –í—ã–≤–æ–¥—ã

–í—ã–≤–æ–¥: –ø–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è —Ç—Ä–µ—Ö –º–æ–¥–µ–ª–µ–π –º—ã —É—Å—Ç–∞–Ω–æ–≤–∏–ª–∏ –ª—É—á—à—É—é - —ç—Ç–æ LogisticRegression. –ò–∑–Ω–∞—á–∞–ª—å–Ω–æ –Ω–∞–±–ª—é–¥–∞–ª—Å—è –¥–∏—Å–±–∞–ª–∞–Ω—Å –∫–ª–∞—Å—Å–æ–≤, –∫–æ—Ç–æ—Ä—ã–π –º—ã —É—Å—Ç—Ä–∞–Ω–∏–ª–∏ —Å –ø–æ–º–æ—â—å—é –∏—Ö –≤–∑–≤–µ—à–∏–≤–∞–Ω–∏—è –∏ –¥–∞—É–Ω—Å—ç–º–ø–ª–∏–Ω–≥–∞. –£–¥–∞–ª–æ—Å—å –¥–æ–±–∏—Ç—å—Å—è –ø–æ–≤—ã—à–µ–Ω–∏—è F1-–º–µ—Ä—ã. –í –∏—Ç–æ–≥–µ –Ω–∞ —Ñ–∏–Ω–∞–ª—å–Ω–æ–º —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –Ω–∞–º —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ç—Ä–µ–±—É–µ–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ f1 - 0.75, –∑–Ω–∞—á–µ–Ω–∏–µ auc_roc —Ç–∞–∫–∂–µ –≤—ã—à–µ –∫–æ–Ω—Å—Ç–∞–Ω—Ç–Ω–æ–π –º–æ–¥–µ–ª–∏.

<div class="alert alert-block alert-danger">
<b>–û—à–∏–±–∫–∞:</b> –ü–æ—Å–ª–µ –∞–Ω–∞–ª–∏–∑–∞ –∏ –≤—ã–±–æ—Ä–∞ –æ–¥–Ω–æ–π –Ω–∞–∏–ª—É—á—à–µ–π –º–æ–¥–µ–ª–∏, –¥–æ–ª–∂–Ω–æ –∏–¥—Ç–∏  –µ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ. –î—Ä—É–≥–∏–µ –º–æ–¥–µ–ª–∏ —Ç–µ—Å—Ç–æ–≤—É—é –≤—ã–±–æ—Ä–∫—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–µ –¥–æ–ª–∂–Ω—ã.
</div>

<div class="alert alert-block alert-warning">
<b>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Å—Ç—É–¥–µ–Ω—Ç–∞: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–≤–µ–¥–µ–Ω–æ</b> 
</div>

<div class="alert alert-block alert-success">
    
<b>–£—Å–ø–µ—Ö[2]:</b> –ü–æ–ª—É—á–µ–Ω–æ —Ö–æ—Ä–æ—à–µ–µ –∫–∞—á–µ—Å—Ç–≤–æ –Ω–∞ —Ç–µ—Å—Ç–µ!
</div>


## –ß–µ–∫-–ª–∏—Å—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏

- [x]  Jupyter Notebook –æ—Ç–∫—Ä—ã—Ç
- [ ]  –í–µ—Å—å –∫–æ–¥ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫
- [ ]  –Ø—á–µ–π–∫–∏ —Å –∫–æ–¥–æ–º —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω—ã –≤ –ø–æ—Ä—è–¥–∫–µ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è
- [ ]  –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω—ã
- [ ]  –ú–æ–¥–µ–ª–∏ –æ–±—É—á–µ–Ω—ã
- [ ]  –ó–Ω–∞—á–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫–∏ *F1* –Ω–µ –º–µ–Ω—å—à–µ 0.75
- [ ]  –í—ã–≤–æ–¥—ã –Ω–∞–ø–∏—Å–∞–Ω—ã
